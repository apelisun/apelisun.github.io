<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ape_li</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="ape_li">
<meta property="og:url" content="https://apelisun.github.io/index.html">
<meta property="og:site_name" content="ape_li">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ape_li">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="ape_li" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 6.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
				<img lazy-src="/img/header.jpg" class="js-avatar">
			
		</a>

		<hgroup>
			<h1 class="header-author"><a href="/">ape_li</a></h1>
		</hgroup>

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">目录</a></li>
				        
						</ul>
					</nav>
					<nav class="half-header-menu">
						<a class="hide">Home</a>
						<a>Tags</a>
						<a>Links</a>
						<a>About</a>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
						<!-- music -->
						
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/B-%E6%A0%91/" style="font-size: 10px;">B+树</a> <a href="/tags/area/" style="font-size: 10px;">area</a> <a href="/tags/collection/" style="font-size: 10px;">collection</a> <a href="/tags/homework/" style="font-size: 10px;">homework</a> <a href="/tags/index/" style="font-size: 10px;">index</a> <a href="/tags/interview/" style="font-size: 10px;">interview</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/meet-DB/" style="font-size: 10px;">meet DB</a> <a href="/tags/msql/" style="font-size: 10px;">msql</a> <a href="/tags/mysql/" style="font-size: 20px;">mysql</a> <a href="/tags/procedure/" style="font-size: 10px;">procedure</a> <a href="/tags/view/" style="font-size: 10px;">view</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">数据库基础</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/">github</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">I&#39;m a developer.</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/header.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">目录</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-mybatis" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/08/16/mybatis/" class="article-date">
  	<time datetime="2022-08-16T11:14:21.419Z" itemprop="datePublished">2022-08-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="编程题"><a href="#编程题" class="headerlink" title="编程题"></a>编程题</h2><blockquote>
<ol>
<li>创建回复表,并且模拟合适的数据</li>
<li>给定一个评论id,删除该评论下的所有的回复.但是要保留该评论下面的评论.</li>
<li>给定一个视频id,将这个视频下的所有的评论以及回复信息全部加载出来.</li>
</ol>
</blockquote>
<p>1发布了视频</p>
<p>​	2(评论）哈哈  ,挺搞笑</p>
<p>​	3-2 (评论）你笑什么</p>
<p>​	4-2 (评论）你傻笑？有病？</p>
<p>​			5-3（回复） 别人不能笑？</p>
<p>​			2-3（回复） 笑一笑十年少</p>
<p>​			5-2（回复） 他有病</p>
<p>​			2-5（回复） 是的</p>
<p>​			6-2（回复） 嗯嗯，笑别人，确实有毛病</p>
<h1 id="解答题"><a href="#解答题" class="headerlink" title="解答题"></a>解答题</h1><blockquote>
<ol>
<li><strong>Mybatis有哪些Executor执行器？</strong></li>
</ol>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SimpleExecutor：每执行一次update或select，就开启一个Statement对象，用完立刻关闭Statement对象。</span><br><span class="line">ReuseExecutor：执行update或select，以sql作为key查找Statement对象，存在就使用，不存在就创建，用完后，不关闭Statement对象，而是放置于Map内，供下一次使用。简言之，就是重复使用Statement对象。</span><br><span class="line">BatchExecutor：执行update（没有select，JDBC批处理不支持select），将所有sql都添加到批处理中（addBatch()），等待统一执行（executeBatch()），它缓存了多个Statement对象，每个Statement对象都是addBatch()完毕后，等待逐一执行executeBatch()批处理。与JDBC批处理相同。</span><br><span class="line"></span><br><span class="line">CachingExecutor：CachingExecutor是一个Executor接口的装饰器，它为Executor对象增加了二级缓存的相关功能，委托的执行器对象可以是SimpleExecutor、ReuseExecutor、BatchExecutor中任一一个。执行 update 方法前判断是否清空二级缓存；执行 query 方法前先在二级缓存中查询，命中失败再通过被代理类查询。</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<ol>
<li>Mybatis是如何进行分页的？分页插件的原理是什么？</li>
</ol>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mybatis 使用 RowBounds 对象进行分页，它是针对 ResultSet 结果集执行的内存分页，而非物理分页。可以在 sql 内直接书写带有物理分页的参数来完成物理分页功能，也可以使用分页插件来完成物理分页。分页插件的基本原理是使用 Mybatis 提供的插件接口，实现自定义插件，在插件的拦截方法内拦截待执行的 sql，然后重写 sql，根据 dialect 方言，添加对应的物理分页语句和物理分页参数</span><br></pre></td></tr></tbody></table></figure>



<ol>
<li>mybatis优缺点</li>
</ol>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.简单易学，容易上手（相比较于hibernate）,基于sql编程。</span><br><span class="line">2.JDBC相比减少50%以上的代码量，不需要手动开启连接。</span><br><span class="line">3.与各种数据库兼容。（因为他与JDBC连接数据库）。</span><br><span class="line">4.提供了许多第三方插件。（分页插件，逆向工程）。</span><br><span class="line">5.能够与spring很好的集成。</span><br><span class="line">6.mybatis相当灵活，不会对现有程序影响，sql写在XML中，从程序代码中彻底分离出来，解除了sql与程序耦合，重用</span><br><span class="line">7.提供XML标签，支持编写sql语句。</span><br><span class="line">8.提供映射标签，支持对象与数据库的orm字段关系映射</span><br></pre></td></tr></tbody></table></figure>



<ol>
<li><p>$和#区别</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">相同点：</span><br><span class="line">都能取到变量的值。</span><br><span class="line">不同点：</span><br><span class="line">#可以实现预编译，会先把#{变量}编译成?，在执行时再取值，可以防止sql注入。</span><br><span class="line">$是直接进行字符串替换。</span><br></pre></td></tr></tbody></table></figure>


</li>
<li><p><strong>Mybatis动态sql有什么用？执行原理？有哪些动态sql？</strong></p>
</li>
</ol>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1、Mybatis 动态 sql 可以让我们在 Xml 映射文件内，以标签的形式编写动态 sql，完成逻辑判断和动态拼接 sql 的功能。</span><br><span class="line"></span><br><span class="line">2、Mybatis 提 供 了 9 种 动 态 sql 标 签 ： trim|where|set|foreach|if|choose|when|otherwise|bind。</span><br><span class="line"></span><br><span class="line">3、其执行原理为，使用 OGNL 从 sql 参数对象中计算表达式的值，根据表达式的值动态拼接 sql，以此来完成动态 sql 的功能。</span><br></pre></td></tr></tbody></table></figure>



<ol>
<li>resultType和resultMap区别</li>
</ol>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">resultmap与resulttype的区别为：对象不同、描述不同、类型适用不同</span><br><span class="line">一、对象不同</span><br><span class="line">1、resultmap：resultMap如果查bai询出来的列名和pojo的属性名不一致，通过定义一个resultMap对列名和pojo属性名之间作一个映射关系。</span><br><span class="line">2、resulttype：resultType使用resultType进行输出映射，只有查询出来的列名和pojo中的属性名一致，该列才可以映射成功。</span><br><span class="line">二、描述不同</span><br><span class="line">1、resultmap：resultMap对于一对一表连接的处理方式通常为在主表的pojo中添加嵌套另一个表的pojo，然后在mapper.xml中采用association节点元素进行对另一个表的连接处理。</span><br><span class="line">2、resulttype：resultType无法查询结果映射到pojo对象的pojo属性中，根据对结构集查询遍历的需要选择使用resultType还是resultMap。</span><br><span class="line">三、类型适用不同</span><br><span class="line">1、resultmap：mybatis中在查询进行select映射的时候，返回类型可以用resultType，也可以用resultMap。</span><br><span class="line">2、resulttype：resultType是直接表示返回类型的,而resultMap则是对外部ResultMap的引用，但是resultType跟resultMap不能同时存在。</span><br><span class="line">如果你要用resulttype返回一个复杂对象的话，就必须返回这个对象的所有属性</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<ol>
<li>Mybatis是否支持延迟加载？ 如果支持它的原理是什么？</li>
</ol>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mybatis 仅支持 association 关联对象和 collection 关联集合对象的延迟加载，association 指的就是一对一，collection 指的就是一对多查询。在 Mybatis配置文件中，可以配置是否启用延迟加载 lazyLoadingEnabled=true|false。它的原理是，使用 CGLIB 创建目标对象的代理对象，当调用目标方法时，进入拦截器方法，比如调用 a.getB().getName()，拦截器 invoke()方法发现 a.getB()是null 值，那么就会单独发送事先保存好的查询关联 B 对象的 sql，把 B 查询上来，然后调用 a.setB(b)，于是 a 的对象 b 属性就有值了，接着完成 a.getB().getName()方法的调用。这就是延迟加载的基本原理。</span><br><span class="line">当然了，不光是 Mybatis，几乎所有的包括 Hibernate，支持延迟加载的原理都</span><br><span class="line">是一样的。</span><br></pre></td></tr></tbody></table></figure>



<ol>
<li><p>什么是ORM</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ORM是一种思想，ORM （全称为 ：Object Relative Mapping）对象-关系映射</span><br><span class="line"></span><br><span class="line">，关系数据库是企业级应用环境中永久存放数据的主流数据存储系统。对象和关系数据是业务实体的两种表现形式，业务实体在内存中表现为对象，在数据库中表现为关系数据。内存中的对象之间存在关联和继承关系，而在数据库中，关系数据无法直接表达多对多关联和继承关系。因此，对象-关系映射(ORM)系统一般以中间件的形式存在，主要实现程序对象到关系数据库数据的映射。</span><br></pre></td></tr></tbody></table></figure>




</li>
<li><p>当实体类中的属性名和表中的字段名不一样 ，怎么办 ？</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第 1 种： 通过在查询的 sql 语句中定义字段名的别名，让字段名的别名和实体类 的属性名一致。</span><br><span class="line">第 2 种： 通过来映射字段名和实体类属性名的一一对应的关系。</span><br></pre></td></tr></tbody></table></figure>



<ol>
<li><p>如何获取自动生成的(主)键值?</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在&lt;insert&gt;标签中使用 useGeneratedKeys   和  keyProperty 两个属性来获取自动生成的主键值。</span><br><span class="line">示例:</span><br><span class="line">&lt;insert id=”insertname” usegeneratedkeys=”true” keyproperty=”id”&gt;  </span><br><span class="line">    insert into names (name) values (#{name})  </span><br><span class="line">&lt;/insert&gt;  </span><br><span class="line">  </span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-review" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/08/13/review/" class="article-date">
  	<time datetime="2022-08-13T08:15:53.037Z" itemprop="datePublished">2022-08-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><span class="line">drop table comment;</span><br><span class="line">create table comment(</span><br><span class="line">id int(7) primary key,</span><br><span class="line">content varchar(20),</span><br><span class="line">comment_date date,</span><br><span class="line">article_id int(7),</span><br><span class="line">constraint com_fk foreign key(article_id) references article(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">drop table article;</span><br><span class="line">create table article(</span><br><span class="line">id int(7) primary key,</span><br><span class="line">title varchar(20),</span><br><span class="line">author varchar(20),</span><br><span class="line">content varchar(20),</span><br><span class="line">post_date date</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert into article(id,title,author,content,post_date) values(10000,'Title','admin',null,'2022-08-13');</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">drop  table department;</span><br><span class="line">create table department(</span><br><span class="line">depid int(7) primary key,</span><br><span class="line">depname varchar(20),</span><br><span class="line">depnote varchar(20)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">drop table employee;</span><br><span class="line">create table employee(</span><br><span class="line">empid int(7) primary key,</span><br><span class="line">empname varchar(20),</span><br><span class="line">empsex int(2),</span><br><span class="line">depart int(7),</span><br><span class="line">salary double(10,2),</span><br><span class="line">position varchar(20)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into department values(1,'软件研发部',null),(2,'系统集成部',null);</span><br><span class="line"></span><br><span class="line">insert into employee values(2017001,'张三',1,1,8000.00,'职员'),(2017002,'李四',1,1,12000.00,null),(2017003,'王五',1,2,3500.00,'职员'),(2017004,'赵六',2,2,8500.00,'职员');</span><br><span class="line"></span><br><span class="line">select empid,empname, case empsex when '1' then '男' else '女' end as empsex,</span><br><span class="line">case depart when '1' then '软件研发部' else '系统集成部' end as dapartment,salary,position from employee ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select empid,empname, case empsex when '1' then '男' else '女' end as empsex,depart,salary,position from employee ;</span><br><span class="line"></span><br><span class="line">-- case depart when '1' then '软件研发部' else '系统集成部' end as dapartment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">***case cloumn_name when 'value' then 'your vlaue' else 'your value' end as alias*** </span><br><span class="line"></span><br><span class="line">-- select * from employee e1  where exists (select 1 from employee e2 where e2.salary&gt;e1.salary  having count(empid)=0) ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- select * from employee e1 where exists (select 1 from employee e2 where e2.salary&lt;e1.salary having count(*)=0);</span><br><span class="line"></span><br><span class="line">update employee set position='试用期' where position is null or salary&lt;5000;</span><br><span class="line"></span><br><span class="line">-- method one:</span><br><span class="line">update employee e set e.salary=e.salary*1.1 where depart=(select depid from department where depname='软件研发部');</span><br><span class="line"></span><br><span class="line">-- method two:</span><br><span class="line">update (employee e join department d on e.depart=d.depid) set e.salary=e.salary*1.1 where d.depname='软件研发部';</span><br><span class="line"></span><br><span class="line">/</span><br><span class="line">*题2</span><br><span class="line">*</span><br><span class="line">/</span><br><span class="line">topic two</span><br><span class="line"></span><br><span class="line">drop table table1;</span><br><span class="line">create table table1(</span><br><span class="line">year int(7),</span><br><span class="line">month int(7),</span><br><span class="line">amount double(3,1)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into table1 values(1991,1,1.1),(1991,2,1.2),(1991,3,1.3),(1991,4,1.4),(1992,1,2.1),(1992,2,2.2),(1992,3,2.3),(1992,4,2.4);</span><br><span class="line"></span><br><span class="line">select year, (select t.month from table1  t where month=1  ) m1 from table1;</span><br><span class="line"></span><br><span class="line">select year,</span><br><span class="line">   sum(case month when '1' then amount else 0 end)  as m1,sum(case month when '2' then amount else 0 end)  as m2,sum(case month when '3' then amount else 0 end)  as m3,sum(case month when '4' then amount else 0 end) as m4 from table1 group by year;</span><br><span class="line">   </span><br><span class="line"> -- 解释 </span><br><span class="line"> 分组后month有4行记录，只有1月的能得到他的aomunt,也就是1.1，其余都是零，故，合并之后应该求和</span><br><span class="line">+------+------+------+------+------+</span><br><span class="line">| year | m1   | m2   | m3   | m4   |</span><br><span class="line">+------+------+------+------+------+</span><br><span class="line">| 1991 |  1.1 |  1.2 |  1.3 |  1.4 |</span><br><span class="line">| 1992 |  2.1 |  2.2 |  2.3 |  2.4 |</span><br><span class="line">+------+------+------+------+------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">题3</span><br><span class="line">**/</span><br><span class="line">topic there</span><br><span class="line"></span><br><span class="line">drop table student;</span><br><span class="line">create table student(</span><br><span class="line">sno int(7) primary key not null unique,</span><br><span class="line">sname varchar(20) ,</span><br><span class="line">sex varchar(2),</span><br><span class="line">sage int(7),</span><br><span class="line">sdept varchar(20)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">drop table course;</span><br><span class="line">create table course(</span><br><span class="line">cno int(7) auto_increment not null unique,</span><br><span class="line">cname varchar(20),</span><br><span class="line">cpno int(7),</span><br><span class="line">credit int (7)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">drop table sc;</span><br><span class="line">create table sc(</span><br><span class="line">sno int(7) ,</span><br><span class="line">cno int(7),</span><br><span class="line">grade int(5),</span><br><span class="line">constraint sc_pk primary key(sno,cno),</span><br><span class="line">constraint sc_fk foreign key(sno) references student(sno),</span><br><span class="line">constraint sc_fk2 foreign key(cno) references </span><br><span class="line">course(cno)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into student values(95001,'李勇','男',20,'cs'),(95002,'刘晨','女',19,'is'),(95003,'王明','女',18,'ma'),(95004,'张立','男',19,'is');</span><br><span class="line"></span><br><span class="line">insert into course values(1,'数据库',5,4),(2,'数学',null,2),(3,'信息系统',1,4),(4,'操作系统',6,3),(5,'数据结构',7,4),(6,'数据处理',0,3),(7,'PASCAL',6,4);</span><br><span class="line"></span><br><span class="line">insert into sc values(95001,1,92),(95001,2,85),(95001,3,89),(95002,2,90),(95003,3,80);</span><br><span class="line"></span><br><span class="line">-- **copy table to other database** comment 'same database as well'</span><br><span class="line">CREATE TABLE new_table LIKE old_database.old_table;</span><br><span class="line">INSERT new_table SELECT * FROM old_database.old_tablel;</span><br><span class="line">for example:</span><br><span class="line">create table course like review.course;</span><br><span class="line">insert course select *from review.course;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql add drop alter</span><br><span class="line">ALTER TABLE table</span><br><span class="line">Grammer:ADD [COLUMN] column_name_1 column_1_definition</span><br><span class="line"></span><br><span class="line">for example:</span><br><span class="line">alter table student add column nation varchar(10);</span><br><span class="line"> </span><br><span class="line">alter table student drop column nation;</span><br><span class="line"> </span><br><span class="line">alter table student modify column nation varchar(20);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">alter table student add column nation varchar(20)</span><br><span class="line">update student set nation='汉族' where sname='王明';</span><br><span class="line"></span><br><span class="line">update:</span><br><span class="line">UPDATE &lt;表名&gt; SET 字段 1=值 1 [,字段 2=值 2… ] [WHERE 子句 ] [ORDER BY 子句] [LIMIT 子句]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select sname,sex from student where sdept='is' or sdept='cs';</span><br><span class="line"></span><br><span class="line">select c.cno,c.cname,count(s.sno) from course c left join sc s on s.cno=c.cno group by c.cno;</span><br><span class="line"></span><br><span class="line">select c.cno,c.cname from course c join sc s on</span><br><span class="line">s.cno=c.cno where exists (select 1 from sc s2 where c.cno=s2.cno having avg(s2.grade)&gt;88);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete from student where sno=95003;</span><br><span class="line"></span><br><span class="line">ALTER TABLE table_name DROP PRIMARY KEY;</span><br><span class="line"></span><br><span class="line">ALTER TABLE table_name DROP INDEX index_name;</span><br><span class="line"></span><br><span class="line">ALTER TABLE table_name DROP FOREIGN KEY （fk_symbol）</span><br><span class="line"> </span><br><span class="line">for example:</span><br><span class="line">alter table sc drop foreign key sc_fk;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">题4</span><br><span class="line">**/</span><br><span class="line">-- topic 4</span><br><span class="line"></span><br><span class="line">select s1.* from scores s1</span><br><span class="line">where exists (select 1 from scores s2 where s1.subject=s2.subject and s1.score&lt;s2.score having count(*)&lt;3)</span><br><span class="line">order by s1.subject,s1.score desc;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create table score(</span><br><span class="line">sid int(7) primary key,</span><br><span class="line">sno int(7),</span><br><span class="line">cno int(7),</span><br><span class="line">grade double(5,2)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into score values(1,95001,1,100),(2,95002,2,95),(3,95003,2,85),(4,95006,3,86),(5,95002,4,90),(6,95005,5,89),(7,95005,3,200),(8,95003,1,100),(9,95004,7,40),(10,95005,4,50),(11,95003,2,100),(12,95003,6,100);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select s.sname,c.cname,sc.grade from student s join score sc on s.sno=sc.sno join course c on c.cno=sc.cno where exists( select 1 from score sc2 where sc2.grade&gt;sc.grade and sc2.cno=sc.cno group by sc2.grade,sc2.cno having count(*)&lt;2) order by cname,grade;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select s1.name,s1.subject,s1.score from scores s1</span><br><span class="line">group by s1.name,s1.subject,s1.score</span><br><span class="line">having count(1)&lt;3</span><br><span class="line">order by subject,score desc;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">题5</span><br><span class="line">**/</span><br><span class="line"></span><br><span class="line">topic 5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create table student (</span><br><span class="line">sno int(7) primary key,</span><br><span class="line">sname varchar(20),</span><br><span class="line">sage int(10),</span><br><span class="line">sex varchar(2),</span><br><span class="line">hlocation varchar(50),</span><br><span class="line">phone varchar(20)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">alter table  student add column degree varchar(20);</span><br><span class="line">alter table  student drop column hlocation;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert into student values(1,'A',22,'男','123456','小学'),(2,'B',21,'男','119','中学'),(3,'C',23,'男','110','高中'),(4,'D',18,'女','114','大学');</span><br><span class="line"></span><br><span class="line">update student set degree='大专' where phone like "11%";</span><br><span class="line"></span><br><span class="line">delete from student where sname like 'C%' and sex='男';</span><br><span class="line"></span><br><span class="line">select sname,sno from student where sage&lt;22 and degree='大专';</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-jdbc01" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/08/11/jdbc01/" class="article-date">
  	<time datetime="2022-08-11T07:50:48.000Z" itemprop="datePublished">2022-08-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h1><blockquote>
<p>jdbc - java database connectivity - java数据库连接</p>
<p>用java编写的程序来连接的数据库的技术.jdbc是sun公司制定的一套”规范”,里面提供了大量的接口.由不同的db厂商进行实现.</p>
<p>而这些实现类就是驱动.</p>
<p>jdbc是最原始的持久层[和db交互层]的技术,属于JavaEE十三种核心技术中的一种.后期学习的持久层框架都是对jdbc的封装.</p>
</blockquote>
<h2 id="为什么要有jdbc"><a href="#为什么要有jdbc" class="headerlink" title="为什么要有jdbc"></a>为什么要有jdbc</h2><blockquote>
<p><code>如果没有jdbc</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SqlServerDriver</span> <span class="variable">driver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlServerDriver</span>();<span class="comment">//sqlserver</span></span><br><span class="line"></span><br><span class="line"><span class="type">MysqlDriver</span> <span class="variable">driver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MysqlDriver</span>();<span class="comment">//mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//java切换db比较麻烦 - 换一套连接db的代码.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//sun制定jdbc规范 - 连接db的规范</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//java.sql.Driver[I],不同的db厂商都是要去实现这个接口的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//伪代码</span></span><br><span class="line">Class.forName(<span class="string">"驱动类的全限定名"</span>);  <span class="comment">// 可以配置到文件中的.</span></span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h2 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h2><blockquote>
<p>为java程序访问不同的db提供统一的方式.在切换db的时候,能够做到最少改动.</p>
</blockquote>
<h2 id="相关api"><a href="#相关api" class="headerlink" title="相关api"></a>相关api</h2><blockquote>
<ol>
<li><p>java.sql.Driver[I] - 每个驱动程序类必须实现的接口.  jdbc编程第一步就是需要加载驱动[jdbc规范4.x开始可以省略不写]</p>
</li>
<li><p>java.sql.DriverManager[C] - 驱动管理类.  获取连接</p>
<ul>
<li><p>static Connection getConnection(String url,String user,String password)</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user : db用户名</span><br><span class="line">password: db密码</span><br><span class="line">url: 主协议:次协议:<span class="comment">//ip地址:端口号/db名称?key1=value1&amp;key2=value2</span></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</li>
<li><p>java.sql.Connection[I] - 一次会话/连接</p>
<ul>
<li>Statement createStatement();</li>
<li>PreparedStatement prepareStatement(String sql);//预编译语句对象</li>
<li>CallableStatement prepareCall();// 调用存储过程.</li>
</ul>
</li>
<li><p>java.sql.Statement[I] - 负责将sql语句发送到db-server端</p>
<ul>
<li>int executeUpdate(String sql);// 用于执行DML操作,insert,update,delete</li>
<li>ResultSet executeQuery(String sql);//用于执行DQL语句</li>
</ul>
</li>
<li><p>java.sql.ResultSet[I] - 结果集对象</p>
<p>本质上仅仅是一个游标.默认指向第一行的上方.</p>
<ul>
<li>boolean next();//1. 游标向下移动一行;2. 如果下一行没有行记录,则返回false</li>
<li>取列值.  String getString(int colINdex);//根据列的序号取值,第一列就是1</li>
<li>取列值 - String getString(String colName);//根据列的名称(支持使用别名)</li>
</ul>
</li>
</ol>
</blockquote>
<h1 id="体验"><a href="#体验" class="headerlink" title="体验"></a>体验</h1><blockquote>
<p>查询 - 六大编程步骤</p>
</blockquote>
<blockquote>
<ol>
<li><p>脚本</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">drop table jdbc_user;</span><br><span class="line">create table jdbc_user(</span><br><span class="line">    id int(7) primary key auto_increment,</span><br><span class="line">    username varchar(20) not null unique,</span><br><span class="line">    password varchar(20),</span><br><span class="line">    birthday date,</span><br><span class="line">    power int(1) comment '0-管理员,1-普通用户'</span><br><span class="line">);</span><br><span class="line">insert into jdbc_user values(1,'admin','123','2021-01-01',0);</span><br><span class="line">insert into jdbc_user values(2,'tom','123','2021-01-01',1);</span><br><span class="line">insert into jdbc_user values(3,'蔡根花','123','2021-01-02',1);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>实体类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line">  <span class="keyword">private</span> Integer id;</span><br><span class="line">  <span class="keyword">private</span> String username;</span><br><span class="line">  <span class="keyword">private</span> String password;</span><br><span class="line">  <span class="keyword">private</span> Date birthday;</span><br><span class="line">  <span class="keyword">private</span> Integer power; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>制定持久层的接口 - IUserDao.java</p>
</li>
<li><p>制定持久层的实现类 - UserDaoImpl.java</p>
</li>
<li><p>单元测试</p>
</li>
</ol>
</blockquote>
<h1 id="Statement弊端"><a href="#Statement弊端" class="headerlink" title="Statement弊端"></a>Statement弊端</h1><blockquote>
<ol>
<li><p>参数硬拼接到了sql语句中,比较麻烦的</p>
</li>
<li><p>容易造成SQL注入 - 非法的参数/sql硬拼接到了sql语句中.</p>
</li>
<li><p>缺点 - 通过语句对象每次发送sql到db-server端,都是需要对sql语句进行编译和解析的.但是业务中可能遇到同构的sql.</p>
<p>同构的sql还是会多次编译和解析的,比较影响性能.</p>
</li>
<li><p>优点 - 一个statement对象可以用来多次发送不同的sql语句.</p>
</li>
</ol>
</blockquote>
<h1 id="PreparedStatement-I"><a href="#PreparedStatement-I" class="headerlink" title="PreparedStatement[I]"></a>PreparedStatement[I]</h1><blockquote>
<p>预编译语句对象</p>
<p>提前将带有占位符号的sql发送到db-server进行解析,后面只要发送参数即可.适合同构的sql</p>
<p>缺点: 一个pst对象,只能编译一条sql语句.</p>
</blockquote>
<h1 id="批处理效率问题"><a href="#批处理效率问题" class="headerlink" title="批处理效率问题"></a>批处理效率问题</h1><blockquote>
<p>addBatch(String sql);//向当前批处理中添加一条sql语句。<br>executeBatch();//执行批处理<br>clearBatch();//清空批处理</p>
<p>需要在url中添加rewriteBatchedStatements=true</p>
</blockquote>
<h2 id="JDBC事务"><a href="#JDBC事务" class="headerlink" title="JDBC事务"></a>JDBC事务</h2><blockquote>
<ul>
<li><p>jdbc事务 - 由连接的db决定</p>
</li>
<li><p>jdbc事务 - 编程性事务 - 事务代码和应用程序代码耦合在一块儿的.</p>
</li>
<li><p>spring事务 - 声明式事务.事务代码(与业务无关的代码)和应用程序进行分离.</p>
</li>
<li><p>jdbc事务 - dml操作之后默认都是自动commit - executeUpdate</p>
</li>
<li><p>代码示例的结构</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">try{</span><br><span class="line">		conn.setAutoCommit(false);</span><br><span class="line">	  </span><br><span class="line">		conn.commit();</span><br><span class="line">}catch(Exception e){</span><br><span class="line">	  conn.rollback();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</blockquote>
<h1 id="模板设计模式"><a href="#模板设计模式" class="headerlink" title="模板设计模式"></a>模板设计模式</h1><p><code>针对DML</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">PreparedStatement</span> <span class="variable">pst</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">  conn = JdbcUtil.getConnection();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//特殊的地方 - 个性的地方</span></span><br><span class="line">  pst = conn.prepareStatement(<span class="string">"delete from jdbc_user where id=?"</span>);</span><br><span class="line">  pst.setInt(<span class="number">1</span>,id);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> pst.executeUpdate();</span><br><span class="line">} <span class="keyword">catch</span> (SQLException e) {</span><br><span class="line">  e.printStackTrace();</span><br><span class="line">}<span class="keyword">finally</span> {</span><br><span class="line">  JdbcUtil.close(conn,pst);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="ResultSetMetaData"><a href="#ResultSetMetaData" class="headerlink" title="ResultSetMetaData"></a>ResultSetMetaData</h1><blockquote>
<p>结果集元数据</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-sql优化-1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/08/10/sql%E4%BC%98%E5%8C%96-1/" class="article-date">
  	<time datetime="2022-08-10T12:40:07.000Z" itemprop="datePublished">2022-08-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/08/10/sql%E4%BC%98%E5%8C%96-1/">
        sql优化
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/img/header.jpg" alt=" "></p>
<h3 id="sql优化"><a href="#sql优化" class="headerlink" title="sql优化"></a>sql优化</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">-- sql优化遵守原则</span><br><span class="line">-- 1.减少数据访问： 设置合理的字段类型，启用压缩，通过索引访问等减少磁盘IO</span><br><span class="line">-- 2.返回更少的数据： 只返回需要的字段和数据分页处理 减少磁盘io及网络io</span><br><span class="line">-- 3.减少交互次数： 批量DML操作，函数存储等减少数据连接次数</span><br><span class="line">-- 4.减少服务器CPU开销： 尽量减少数据库排序操作以及全表查询，减少cpu 内存占用</span><br><span class="line">-- 5.利用更多资源： 使用表分区，可以增加并行操作，更大限度利用cpu资源</span><br><span class="line"></span><br><span class="line">-- 总结到SQL优化中，就三点:</span><br><span class="line">-- 最大化利用索引；</span><br><span class="line">-- 尽可能避免全表扫描；</span><br><span class="line">-- 减少无效数据的查询；</span><br><span class="line"></span><br><span class="line">-- sql语句执行顺序</span><br><span class="line">1. select</span><br><span class="line">2. distinct &lt;select_list&gt;</span><br><span class="line">3. from &lt;left_table&gt;</span><br><span class="line">4. &lt;join_type&gt; join &lt;right_table&gt;</span><br><span class="line">5. on &lt;join_condition&gt;</span><br><span class="line">6. where &lt;where_condition&gt;</span><br><span class="line">7. group by &lt;group_by_list&gt;</span><br><span class="line">8. having &lt;having_condition&gt;</span><br><span class="line">9. order by &lt;order_by_condition&gt;</span><br><span class="line">10.limit &lt;limit_number&gt;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- sql优化</span><br><span class="line">一、避免不走索引的场景</span><br><span class="line">1.见博客'索引'索引失效情况（以下为补充）</span><br><span class="line">2.like--被代替-&gt;instr</span><br><span class="line">3.尽量避免使用 or，会导致数据库引擎放弃索引进行全表扫描</span><br><span class="line">二、SELECT语句其他优化</span><br><span class="line">1. 避免出现select *</span><br><span class="line">首先，select * 操作在任何类型数据库中都不是一个好的SQL编写习惯。</span><br><span class="line">使用select * 取出全部列，会让优化器无法完成索引覆盖扫描这类优化，会影响优化器对执行计划的选择，也会增加网络带宽消耗，更会带来额外的I/O,内存和CPU消耗。</span><br><span class="line">建议提出业务实际需要的列数，将指定列名以取代select *。</span><br><span class="line"></span><br><span class="line">2. 避免出现不确定结果的函数</span><br><span class="line">特定针对主从复制这类业务场景。由于原理上从库复制的是主库执行的语句，使用如now()、rand()、sysdate()、current_user()等不确定结果的函数很容易导致主库与从库相应的数据不一致。另外不确定值的函数,产生的SQL语句无法利用query cache。</span><br><span class="line"></span><br><span class="line">3.多表关联查询时，小表在前，大表在后。</span><br><span class="line">在MySQL中，执行 from 后的表关联查询是从左往右执行的（Oracle相反），第一张表会涉及到全表扫描，所以将小表放在前面，先扫小表，扫描快效率较高，在扫描后面的大表，或许只扫描大表的前100行就符合返回条件并return了。</span><br><span class="line">例如：表1有50条数据，表2有30亿条数据；如果全表扫描表2，你品，那就先去吃个饭再说吧是吧。</span><br><span class="line"></span><br><span class="line">4. 使用表的别名</span><br><span class="line">当在SQL语句中连接多个表时，请使用表的别名并把别名前缀于每个列名上。这样就可以减少解析的时间并减少哪些友列名歧义引起的语法错误。</span><br><span class="line"></span><br><span class="line">5. 用where字句替换HAVING字句</span><br><span class="line">避免使用HAVING字句，因为HAVING只会在检索出所有记录之后才对结果集进行过滤，而where则是在聚合前刷选记录，如果能通过where字句限制记录的数目，那就能减少这方面的开销。HAVING中的条件一般用于聚合函数的过滤，除此之外，应该将条件写在where字句中。</span><br><span class="line">where和having的区别：where后面不能使用组函数</span><br><span class="line"></span><br><span class="line">6.调整Where字句中的连接顺序</span><br><span class="line">MySQL采用从左往右，自上而下的顺序解析where子句。根据这个原理，应将过滤数据多的条件往前放，最快速度缩小结果集。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">三、增删改 DML 语句优化</span><br><span class="line">1. 大批量插入数据</span><br><span class="line">Insert into T values(1,2),(1,3),(1,4); </span><br><span class="line">在特定场景可以减少对DB连接次数，SQL语句较短，可以减少网络传输的IO。</span><br><span class="line"></span><br><span class="line">2. 适当使用commit</span><br><span class="line">适当使用commit可以释放事务占用的资源而减少消耗，commit后能释放的资源如下：</span><br><span class="line">事务占用的undo数据块；</span><br><span class="line">事务在redo log中记录的数据块；</span><br><span class="line">释放事务施加的，减少锁争用影响性能。特别是在需要使用delete删除大量数据的时候，必须分解删除量并定期commit。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<h1 id="delete和truncate的区别"><a href="#delete和truncate的区别" class="headerlink" title="delete和truncate的区别"></a>delete和truncate的区别</h1><p>1、在功能上，truncate是清空一个表的内容，它相当于delete from table_name。<br>2、delete是dml操作，truncate是ddl操作；因此，用delete删除整个表的数据时，会产生大量的roolback，占用很多的rollback segments， 而truncate不会。<br>3、在内存中，用delete删除数据，表空间中其被删除数据的表占用的空间还在，便于以后的使用，另外它是“假相”的删除，相当于windows中用delete删除数据是把数据放到回收站中，还可以恢复，当然如果这个时候重新启动系统（OS或者RDBMS），它也就不能恢复了！<br>而用truncate清除数据，内存中表空间中其被删除数据的表占用的空间会被立即释放，相当于windows中用shift+delete删除数据，不能够恢复！<br>4、truncate 调整high water mark 而delete不；truncate之后，TABLE的HWM退回到 INITIAL和NEXT的位置（默认）delete 则不可以。<br>5、truncate 只能对TABLE，delete 可以是table,view,synonym。<br>6、TRUNCATE TABLE 的对象必须是本模式下的，或者有drop any table的权限 而 DELETE 则是对象必须是本模式下的，或被授予 DELETE ON SCHEMA.TABLE 或DELETE ANY TABLE的权限。<br>7、在外层中，truncate或者delete后，其占用的空间都将释放。<br>8、truncate和delete只删除数据，而drop则删除整个表（结构和数据）。</p>
<h1 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h1><p>　　1.TRUNCATE TABLE是非常快的<br>　　2.TRUNCATE之后的自增字段从头开始计数了，而DELETE的仍保留原来的最大数值 </p>
<p>　　TRUNCATE  TABLE  在功能上与不带  WHERE  子句的  DELETE  语句相同：二者均删除表中的全部行。但  TRUNCATE  TABLE  比  DELETE  速度快，且使用的系统和事务日志资源少。<br>DELETE  语句每次删除一行，并在事务日志中为所删除的每行记录一项。TRUNCATE  TABLE  通过释放存储表数据所用的数据页来删除数据，并且只在事务日志中记录页的释放。<br>　　TRUNCATE  TABLE  删除表中的所有行，但表结构及其列、约束、索引等保持不变。新行标识所用的计数值重置为该列的种子。如果想保留标识计数值，请改用  DELETE。如果要删除表定义及其数据，请使用  DROP  TABLE  语句。<br>对于由  FOREIGN  KEY  约束引用的表，不能使用  TRUNCATE  TABLE，而应使用不带  WHERE  子句的  DELETE  语句。由于  TRUNCATE  TABLE  不记录在日志中，所以它不能激活触发器。<br>　　TRUNCATE  TABLE  不能用于参与了索引视图的表。</p>
<h2 id="注意-这里说的delete是指不带where子句的delete语句"><a href="#注意-这里说的delete是指不带where子句的delete语句" class="headerlink" title="注意:这里说的delete是指不带where子句的delete语句"></a>注意:这里说的delete是指不带where子句的delete语句</h2><p> 相同点<br>　　truncate和不带where子句的delete, 以及drop都会删除表内的数据 </p>
<p>不同点:<br>\1. truncate和 delete只删除数据不删除表的结构(定义)<br>  drop语句将删除表的结构被依赖的约束(constrain),触发器(trigger),索引(index); 依赖于该表的存储过程/函数将保留,但是变为invalid状态.<br>2.delete语句是dml,这个操作会放到rollback segement中,事务提交之后才生效;如果有相应的trigger,执行的时候将被触发.<br>  truncate,drop是ddl, 操作立即生效,原数据不放到rollback segment中,不能回滚. 操作不触发trigger.<br>3.delete语句不影响表所占用的extent, 高水线(high watermark)保持原位置不动<br> 显然drop语句将表所占用的空间全部释放<br> truncate 语句缺省情况下见空间释放到 minextents个 extent,除非使用reuse storage;  truncate会将高水线复位(回到最开始).<br>4.速度,一般来说: drop&gt;; truncate &gt;; delete<br>5.安全性:小心使用drop 和truncate,尤其没有备份的时候.否则哭都来不及<br>使用上,想删除部分数据行用delete,注意带上where子句. 回滚段要足够大.<br>想删除表,当然用drop<br>想保留表而将所有数据删除. 如果和事务无关,用truncate即可. 如果和事务有关,或者想触发trigger,还是用delete.<br>如果是整理表内部的碎片,可以用truncate跟上reuse stroage,再重新导入/</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-innoDB-and-myisam" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/08/10/innoDB-and-myisam/" class="article-date">
  	<time datetime="2022-08-10T11:42:19.000Z" itemprop="datePublished">2022-08-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/08/10/innoDB-and-myisam/">
        innoDB_and_myisam
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="innoDB与Myisam的区别"><a href="#innoDB与Myisam的区别" class="headerlink" title="innoDB与Myisam的区别"></a>innoDB与Myisam的区别</h3><ul>
<li><p><strong>InnoDB支持事务，MyISAM不支持</strong>，对于InnoDB每一条SQL语言都默认封装成事务，自动提交，这样会<strong>影响速度</strong>，所以最好把多条SQL语言放在begin和commit之间，组成一个事务；</p>
</li>
<li><p><strong>InnoDB支持外键，而MyISAM不支持</strong>。对一个包含外键的InnoDB表转为MYISAM会<strong>失败</strong>；</p>
</li>
<li><ul>
<li><p>3**.InnoDB是聚集索引<strong>，使用B+Tree作为索引结构，数据文件是和（主键）索引绑在一起的（表数据文件本身就是按B+Tree组织的一个索引结构），必须要有主键，通过主键索引效率很高。但是</strong>辅助索引需要两次查询<strong>，先查询到主键，然后再通过主键查询到数据。因此，</strong>主键不应该过大，因为主键太大**，其他索引也都会-很大。</p>
</li>
<li><p>3.<strong>MyISAM是非聚集索引</strong>，也是使用B+Tree作为索引结构，<strong>索引和数据文件是分离的，</strong>索引保存的是数据文件的指针。<strong>主键索引和辅助索引是独立的</strong>。也就是说：InnoDB的B+树主键索引的叶子节点就是数据文件，辅助索引的叶子节点是主键的值；而MyISAM的B+树主键索引和辅助索引的叶子节点<strong>都是数据文件的地址指针</strong>。</p>
</li>
</ul>
</li>
<li><ol start="4">
<li><strong>InnoDB不保存表的具体行数</strong>，执行select count(*) from table时需要全表扫描。<strong>而MyISAM用一个变量保存了整个表的行数</strong>，执行上述语句时只需要读出该变量即可，速度很快（注意不能加有任何WHERE条件）</li>
</ol>
</li>
<li><ol start="5">
<li><strong>Innodb不支持全文索引，而MyISAM支持全文索引</strong>，在涉及全文索引领域的查询效率上MyISAM速度更快高；PS：<strong>5.7以后的InnoDB支持全文索引了</strong>**</li>
</ol>
</li>
<li><ol start="6">
<li>MyISAM表格可以被<strong>压缩后进行查询操作</strong></li>
</ol>
</li>
<li><p><strong>7. InnoDB支持表、行(默认)级锁，而MyISAM支持表级锁</strong></p>
</li>
<li><p>8、<strong>InnoDB表必须有唯一索引</strong>（如主键）（用户没有指定的话会自己找/生产一个隐藏列Row_id来充当默认主键），<strong>而Myisam可以没有</strong></p>
<p>9、Innodb存储文件有frm、ibd，而Myisam是frm、MYD、MYI</p>
<pre><code>    Innodb：frm是表定义文件，ibd是数据文件

    Myisam：frm是表定义文件，myd是数据文件，myi是索引文件
</code></pre>
</li>
</ul>
<h3 id="如何选择："><a href="#如何选择：" class="headerlink" title="如何选择："></a>如何选择：</h3><p>​    1. 是否要支持事务，如果要请选择innodb，如果不需要可以考虑MyISAM；</p>
<ol start="2">
<li><p>如果表中绝大多数都只是读查询，可以考虑MyISAM，如果既有读也有写，请使用InnoDB。</p>
</li>
<li><p>系统奔溃后，MyISAM恢复起来更困难，能否接受；</p>
</li>
<li><p>MySQL5.5版本开始Innodb已经成为Mysql的默认引擎(之前是MyISAM)，说明其优势是有目共睹的，如果你不知道用什么，那就用InnoDB，至少不会差</p>
</li>
</ol>
<p>InnoDB为什么推荐使用自增ID作为主键？</p>
<p>​		答：自增ID可以保证每次插入时B+索引是从右边扩展的，可以避免B+树和频繁合并和分裂（对比使用UUID）。如果使用字符串主键和随机主键，会使得数据随机插入，效率比较差。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-储存函数触发器" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/08/09/%E5%82%A8%E5%AD%98%E5%87%BD%E6%95%B0%E8%A7%A6%E5%8F%91%E5%99%A8/" class="article-date">
  	<time datetime="2022-08-09T13:24:55.000Z" itemprop="datePublished">2022-08-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/08/09/%E5%82%A8%E5%AD%98%E5%87%BD%E6%95%B0%E8%A7%A6%E5%8F%91%E5%99%A8/">
        储存函数触发器
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#函数function</p>
<blockquote>
<p>mysql中内置了很多函数</p>
<p>mysql8.0不支持创建函数的语法的</p>
<p>解决方案:</p>
<ol>
<li><p>在<strong>my.ini</strong>或者my.cnf文件下添加：</p>
<p>[mysqld]</p>
<p>log-bin-trust-function-creators=1</p>
<p>最后mysql服务器重启</p>
</li>
</ol>
</blockquote>
<h2 id="创建语法"><a href="#创建语法" class="headerlink" title="创建语法"></a>创建语法</h2><blockquote>
<ol>
<li><p>函数体中一定有return语句</p>
</li>
<li><p><strong>只要遇到varchar类型,必须要指定参数的长度</strong></p>
</li>
<li><p>语法部分</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- 重新定制mysql的结束符号,sql语句的结束符号默认的是分号</span><br><span class="line">delimiter $$</span><br><span class="line">         </span><br><span class="line">create function 函数名([变量名 数据类型(长度)]) returns 返回类型</span><br><span class="line">begin</span><br><span class="line">	-- -- 函数体</span><br><span class="line">	return 结果;</span><br><span class="line">end $$</span><br><span class="line">         </span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><blockquote>
<p>传入俩个整数,返回俩个整数的相加的结果</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">delimiter //</span><br><span class="line">create function dy_add(a int,b int) returns int</span><br><span class="line">begin</span><br><span class="line">	return a + b;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">-- 调用函数</span><br><span class="line">select dy_add(50,10);</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h2 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h2><blockquote>
<p>写一个函数可以实现日期转成指定格式的字符串xxxx年xx月xx日</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">date_format(date,pattern)</span><br><span class="line"></span><br><span class="line">drop function dy_format;</span><br><span class="line"></span><br><span class="line">delimiter //</span><br><span class="line">create function dy_format(dt date) returns varchar(20)</span><br><span class="line">begin</span><br><span class="line">	return date_format(dt,'%Y年%m月%d日');</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">select dy_format(now());</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h2 id="语句语法"><a href="#语句语法" class="headerlink" title="语句语法"></a>语句语法</h2><blockquote>
<ol>
<li><p>while..do..end while</p>
<p>求出1~x之间的总和</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">drop function x_add;</span><br><span class="line"></span><br><span class="line">delimiter //</span><br><span class="line">create function x_add(x int) returns int</span><br><span class="line">begin</span><br><span class="line">  -- 循环变量因子,局部变量</span><br><span class="line">	declare i int default 1;</span><br><span class="line">	-- 定义一个变量,用来保存总的和</span><br><span class="line">	declare sums int default 0;</span><br><span class="line">	while i&lt;=x do</span><br><span class="line">		-- 对已经声明过的变量进行赋值操作</span><br><span class="line">		set sums = sums + i;</span><br><span class="line">		set i = i + 1;</span><br><span class="line">	end while;</span><br><span class="line">	return sums;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">select x_add(100);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>分支语句if … then…end if</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  -- 求出1~x之间奇数的总和</span><br><span class="line">drop function ji_add;</span><br><span class="line">  delimiter //</span><br><span class="line">create function ji_add(x int) returns int</span><br><span class="line">begin</span><br><span class="line">	declare i int default 1;</span><br><span class="line">	declare sums int default 0;</span><br><span class="line">	while i&lt;=x do</span><br><span class="line">		if i%2!=0 then</span><br><span class="line">			set sums = sums+i;</span><br><span class="line">		end if;</span><br><span class="line">		set i = i + 1;</span><br><span class="line">	end while;</span><br><span class="line">	return sums;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select ji_add(100);</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><blockquote>
<p>求出1~x之间的数字之和,但是不包括5的倍数</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">drop function my_add;</span><br><span class="line">delimiter //</span><br><span class="line">create function my_add(x int) returns int</span><br><span class="line">begin</span><br><span class="line">	-- 定义一个局部变量</span><br><span class="line">	declare i int default 1;</span><br><span class="line">	-- 定义一个全局变量,用来存储总和</span><br><span class="line">	-- 全局变量  @变量名</span><br><span class="line">	-- 系统的全局变量 @@tx_isolation</span><br><span class="line">	set @sums = 0;</span><br><span class="line">	</span><br><span class="line">	-- 对语句片段进行一个命名 - 类似于java中的continue语句</span><br><span class="line">	-- 命名是任意的</span><br><span class="line">	success:while i&lt;=x do</span><br><span class="line">	  -- mysql中判断是否相等,=</span><br><span class="line">		if i%5=0 then</span><br><span class="line">			set i = i + 1;</span><br><span class="line">			-- continue - 跳过本轮循环,继续下一轮循环</span><br><span class="line">			iterate success;</span><br><span class="line">		end if;</span><br><span class="line">		set @sums = @sums + i;</span><br><span class="line">		set i = i + 1;</span><br><span class="line">	end while;</span><br><span class="line">	return @sums;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select my_add(100);</span><br><span class="line"></span><br><span class="line">-- 全局变量,在函数体外调用</span><br><span class="line">select @sums;</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h1 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h1><blockquote>
<p>定义:为了完成一些特定的工程,提前将sql语句<strong>预编译</strong>好,存储在在mysql-server端.并且只会编译一次.后面直接调用</p>
<p>存储过程的时候,是不需要再次对sql语句进行编译了,提高性能.</p>
<p><strong>存储过程可以做到标准的组件编程[把sql封装好,形成一个组件]</strong></p>
</blockquote>
<h2 id="sql执行的过程"><a href="#sql执行的过程" class="headerlink" title="sql执行的过程"></a>sql执行的过程</h2><blockquote>
<ol>
<li>mysql-client 客户端编写sql语句 mysql&gt; select * from s_emp;</li>
<li>将这个客户端的sql发送到mysql-server端,需要对这条sql进行编译[检测语法]以及解析.</li>
<li>mysql-server将解析之后的结果返回给mysql-client;</li>
</ol>
</blockquote>
<blockquote>
<p>在没有使用存储过程之前,只要将sql语句发送到mysql-server端,每次都是需要对sql进行编译的.比较浪费时间.</p>
</blockquote>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- 删除存储过程</span><br><span class="line">drop procedure 存储过程名;</span><br><span class="line"></span><br><span class="line">-- 创建存储过程</span><br><span class="line">delimiter //</span><br><span class="line">create procedure 存储过程名([in|out] 变量名 数据类型)</span><br><span class="line">begin</span><br><span class="line">	-- 过程体</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="体验"><a href="#体验" class="headerlink" title="体验"></a>体验</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-- 把s_emp表中的员工的平均薪资预编译好在mysql-server端存储</span><br><span class="line">delimiter //</span><br><span class="line">create procedure pro_sal()</span><br><span class="line">begin</span><br><span class="line">	select avg(salary) from s_emp;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">call pro_sal();</span><br></pre></td></tr></tbody></table></figure>

<h2 id="in-接受参数"><a href="#in-接受参数" class="headerlink" title="in - 接受参数"></a>in - 接受参数</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">drop procedure in_pro;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure in_pro(in a int)</span><br><span class="line">begin</span><br><span class="line">	-- 输出System.out.println(a)</span><br><span class="line">	-- 变量a是否有输出</span><br><span class="line">	select a;</span><br><span class="line">	</span><br><span class="line">	-- set @i = 900,但是in来修饰的</span><br><span class="line">	set a = 900;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-- 直接接受一个字面量</span><br><span class="line">call in_pro(10);</span><br><span class="line">-- 接受一个全局变量</span><br><span class="line">set @a=10;</span><br><span class="line">call in_pro(@a);</span><br><span class="line">-- 10</span><br><span class="line">select @a;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="out-返回结果"><a href="#out-返回结果" class="headerlink" title="out - 返回结果"></a>out - 返回结果</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">drop procedure out_pro;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure out_pro(out a int)</span><br><span class="line">begin</span><br><span class="line">	-- 输出System.out.println(a)</span><br><span class="line">	-- out修饰的 - 不能够接受外面传进来的参数</span><br><span class="line">	select a;</span><br><span class="line">	</span><br><span class="line">	-- 给a重新赋值 - set @i = 800</span><br><span class="line">	set a = 800;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-- 注意点:如果参数使用out,那么此处是不允许直接使用字面量进行传参</span><br><span class="line">call out_pro(100);</span><br><span class="line">ERROR 1414 (42000): OUT or INOUT argument 1 for routine dy.out_pro is not a variable or NEW pseudo-variable in BEFORE trigger</span><br><span class="line"></span><br><span class="line">-- 只能使用全局变量进行传参</span><br><span class="line">set @i = 100;</span><br><span class="line">call out_pro(@i);</span><br><span class="line">-- 发现a为null</span><br><span class="line">+------+</span><br><span class="line">| a    |</span><br><span class="line">+------+</span><br><span class="line">| NULL |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">select @i;</span><br><span class="line">+------+</span><br><span class="line">| @i   |</span><br><span class="line">+------+</span><br><span class="line">|  800 |</span><br><span class="line">+------+</span><br></pre></td></tr></tbody></table></figure>

<h2 id="练习-封装单个结果集"><a href="#练习-封装单个结果集" class="headerlink" title="练习 - 封装单个结果集"></a>练习 - 封装单个结果集</h2><h3 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h3><blockquote>
<p>根据员工的id来返回员工的名称,薪资</p>
<p>和表结合一起使用的话,数据类型和表统一</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">drop procedure find_pro;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure find_pro(in eid int(7),out fname varchar(20),out sal float(11,2))</span><br><span class="line">begin</span><br><span class="line">	select first_name into fname from s_emp where id=eid;</span><br><span class="line">	select salary into sal from s_emp where id=eid;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">call find_pro(1,@fname,@sal);</span><br><span class="line">select @fname;</span><br><span class="line">select @sal;</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h3 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h3><blockquote>
<p>统一赋值</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">drop procedure find_pro;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure find_pro(in eid int(7),out fname varchar(20),out sal float(11,2))</span><br><span class="line">begin</span><br><span class="line">	select first_name,salary into fname,sal from s_emp where id=eid;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">call find_pro(1,@fname,@sal);</span><br><span class="line">select @fname;</span><br><span class="line">select @sal;</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h2 id="练习-封装多个结果集"><a href="#练习-封装多个结果集" class="headerlink" title="练习 - 封装多个结果集"></a>练习 - 封装多个结果集</h2><blockquote>
<ol>
<li><p>传统的做法 - 已经被弃用了 - 性能比较低 - <strong>游标</strong></p>
</li>
<li><p>定义第三张表来存储多个结果集</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-- 构建临时表 - 结果集</span><br><span class="line">create table emp_copy as select first_name,salary from s_emp where 1=2;</span><br><span class="line"></span><br><span class="line">drop procedure find_pro;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure find_pro(in eid int(7))</span><br><span class="line">begin</span><br><span class="line">	insert into emp_copy(first_name,salary) select first_name,salary from s_emp where id&gt;eid;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">call find_pro(20);</span><br><span class="line">select * from emp_copy;</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<h2 id="练习-带事务"><a href="#练习-带事务" class="headerlink" title="练习 - 带事务"></a>练习 - 带事务</h2><blockquote>
<p>转账功能 - 要么同时成功,要么同时失败</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">drop procedure transfer_pro;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure transfer_pro(in sid int(7),in tid int(7),in money double(10,2),in st int(7))</span><br><span class="line">begin</span><br><span class="line">	-- 定义一个局部变量,用来展示是否转账成功</span><br><span class="line">	declare msg varchar(20) default '';</span><br><span class="line"></span><br><span class="line">-- 手动开启失败</span><br><span class="line">start transaction;</span><br><span class="line"></span><br><span class="line">-- 第一条sql</span><br><span class="line">update t_acc set balance = balance - money where id = sid;</span><br><span class="line"></span><br><span class="line">-- 故意搞事情</span><br><span class="line">if st=1 then</span><br><span class="line">	set msg = 'sorry,转账失败!';</span><br><span class="line">	-- 事务回滚</span><br><span class="line">	rollback;</span><br><span class="line">else</span><br><span class="line"> -- 第二条sql</span><br><span class="line"> update t_acc set balance = balance + money where id = tid;</span><br><span class="line"> set msg = 'good,转账成功!';</span><br><span class="line">  -- 手动提交事务</span><br><span class="line">		commit;</span><br><span class="line">end if;</span><br><span class="line">select msg;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- 转账成功</span><br><span class="line">call transfer_pro(1,2,1000,2);</span><br><span class="line"></span><br><span class="line">-- 转账失败</span><br><span class="line">call transfer_pro(1,2,1000,1);</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h2 id="语句使用"><a href="#语句使用" class="headerlink" title="语句使用"></a>语句使用</h2><h3 id="条件分支语句"><a href="#条件分支语句" class="headerlink" title="条件分支语句"></a>条件分支语句</h3><blockquote>
<ol>
<li><p>if 条件表达式 then elseif … then … else…end if;</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">drop procedure if_pro;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure if_pro(in a int)</span><br><span class="line">begin</span><br><span class="line">	declare msg varchar(20) default '';</span><br><span class="line">	if a&gt;=90 then</span><br><span class="line">		set msg = '优秀';</span><br><span class="line">	elseif a&gt;=80 then</span><br><span class="line">		set msg = '良好';</span><br><span class="line">	elseif a&gt;=60 then</span><br><span class="line">		set msg = '中等';</span><br><span class="line">	else</span><br><span class="line">		set msg='不及格';</span><br><span class="line">	end if;</span><br><span class="line">	select msg;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call if_pro(85);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>case .. when 固定的值 then .. else .. end case</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">drop procedure case_pro;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure case_pro(in a int)</span><br><span class="line">begin</span><br><span class="line">	declare msg varchar(20) default '';</span><br><span class="line">	case a</span><br><span class="line">		when 1 then</span><br><span class="line">			set msg = '1';</span><br><span class="line">		when 2 then</span><br><span class="line">			set msg = '2';</span><br><span class="line">		else</span><br><span class="line">			set msg = '3';</span><br><span class="line">	end case;</span><br><span class="line">	select msg;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call case_pro(2);</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<h3 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h3><blockquote>
<ol>
<li><p>while … do .. end while</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">drop procedure while_pro;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure while_pro(in x int,out result int) </span><br><span class="line">begin</span><br><span class="line">	-- 定义一个局部变量  int i = 1</span><br><span class="line">	declare i int default 1;</span><br><span class="line">	-- 保存最终的总和</span><br><span class="line">	declare sums int default 0;</span><br><span class="line">	-- 循环</span><br><span class="line">	while i&lt;=x do</span><br><span class="line">		-- sums自增1</span><br><span class="line">		set sums = sums + i;</span><br><span class="line">		-- i应该要自增1</span><br><span class="line">		set i = i + 1;</span><br><span class="line">	end while;</span><br><span class="line">	-- select sums;</span><br><span class="line">	set result = sums;</span><br><span class="line">end //</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">call while_pro(100,@result);</span><br><span class="line">select @result;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>loop  .. end loop - 类似于java中的while(true)</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-- 1~x</span><br><span class="line">drop procedure loop_pro;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure loop_pro(in x int)</span><br><span class="line">begin</span><br><span class="line">	declare i int default 1;</span><br><span class="line">	declare sums int default 0;</span><br><span class="line">	</span><br><span class="line">	success:loop</span><br><span class="line">		if i&gt;x then</span><br><span class="line">			-- 打破循环的语句</span><br><span class="line">			-- iterate success;  类似于continue</span><br><span class="line">			</span><br><span class="line">			-- 类似于break</span><br><span class="line">			leave success;</span><br><span class="line">		end if;</span><br><span class="line">		set sums = sums + i;</span><br><span class="line">		set i = i + 1;</span><br><span class="line">	end loop;</span><br><span class="line">	select sums;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call loop_pro(100);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>repeat … until … end repeat</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">drop procedure repeat_pro;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure repeat_pro(in x int)</span><br><span class="line">begin</span><br><span class="line">  -- 但是先进入到这个循环体中先执行一遍,然后再进行判断</span><br><span class="line">	repeat</span><br><span class="line">		set x = x + 1;</span><br><span class="line">		select x;</span><br><span class="line">	-- 如果x&gt;0,循环停止了</span><br><span class="line">	until x&gt;0</span><br><span class="line">	end repeat;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call repeat_pro(1);</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<h1 id="存储过程和函数的区别"><a href="#存储过程和函数的区别" class="headerlink" title="存储过程和函数的区别"></a>存储过程和函数的区别</h1><blockquote>
<ol>
<li>定义函数的时候,在函数的签名上必须要指定returns返回类型,定义存储过程的时候不需要使用returns来指定返回类型</li>
<li>函数体中必须要有return语句来返回函数的执行结果,但是存储过程中可以没有return语句</li>
<li>调用函数使用select,调用存储过程使用call</li>
<li>存储过程更加侧重于sql的封装以及sql的预编译,提高效率和安全和sql的复用性</li>
<li>存储过程必须要使用in来接受参数,使用out来返回结果</li>
</ol>
</blockquote>
<h1 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h1><p>在myql中,当我们执行一些操作的时候,比如DML操作(触发器触发的事件),一旦事件被触发,那么</p>
<p>就会执行一段程序.<strong>触发器本质上就是一个特殊的存储过程.</strong></p>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><ul>
<li>after触发器 - 在触发条件之后执行</li>
<li>before触发器 - 在触发条件之前执行</li>
</ul>
<h2 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-- 删除触发器</span><br><span class="line">drop trigger 触发器名称;</span><br><span class="line">delimiter $$</span><br><span class="line">-- 创建触发器</span><br><span class="line">create trigger 触发器名</span><br><span class="line">触发时机(after,before) 触发事件(insert,delete,update) on 触发器事件所在的表名</span><br><span class="line">for each row</span><br><span class="line">-- 触发器需要执行的逻辑.</span><br><span class="line">begin</span><br><span class="line">end</span><br><span class="line">$$</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="练习-2"><a href="#练习-2" class="headerlink" title="练习"></a>练习</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table t_acc_copy as select * from t_acc where 1=2;</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<ol>
<li><p>删除t_acc表中的任意一条数据之后,会在t_acc_copy表中插入一条.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">drop trigger acc_tri;</span><br><span class="line">delimiter //</span><br><span class="line">create trigger acc_tri</span><br><span class="line">after delete on t_acc</span><br><span class="line">for each row</span><br><span class="line">begin</span><br><span class="line">	insert into t_acc_copy values(old.id,old.balance);</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; delete from t_acc where id=1;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t_acc_copy;</span><br><span class="line">+------+---------+</span><br><span class="line">| id   | balance |</span><br><span class="line">+------+---------+</span><br><span class="line">|    1 | 1000.00 |</span><br><span class="line">+------+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>级联删除 - 删除t_customer中的客户信息之前需要级联删除该客户的订单信息</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">drop trigger acc_tri;</span><br><span class="line">delimiter //</span><br><span class="line">create trigger cus_tri</span><br><span class="line">before delete on t_customer</span><br><span class="line">for each row</span><br><span class="line">begin</span><br><span class="line">	delete from t_ord where customer_id=old.id;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">delete from t_customer where id=2;</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li><p>oracle中支持自检约束check</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drop table cks;</span><br><span class="line">create table cks(</span><br><span class="line">	id int(7) primary key auto_increment,</span><br><span class="line">  age int(7)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into cks values(1,30);</span><br><span class="line">insert into cks values(2,30);</span><br><span class="line"></span><br><span class="line">auto_increment 主键自增长的策略,默认值是从1开始,步长为1.  主键列不需要设置值</span><br><span class="line">insert into cks(age) values(20);</span><br><span class="line">insert into cks(age) values(30);</span><br><span class="line">delete from cks where id=2;</span><br><span class="line">insert into cks(age) values(40);</span><br><span class="line">select * from cks;</span><br><span class="line"></span><br><span class="line">-- auto_increment - 主键列数据类型不能是varchar</span><br><span class="line">-- auto_increment到达最大值</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li><p>mysql用触发器来实现自检约束</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-- 插入age只能在(0,18]区间,否则报错.</span><br><span class="line">drop trigger cks_tri;</span><br><span class="line">delimiter //</span><br><span class="line">create trigger cks_tri</span><br><span class="line">before insert on cks</span><br><span class="line">for each row</span><br><span class="line">begin</span><br><span class="line">	if new.age&lt;0 or new.age&gt;18 then</span><br><span class="line">		signal sqlstate '42000' set message_text='age必须在0~18区间';</span><br><span class="line">	end if;</span><br><span class="line">end //</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">insert into cks(age) values(200);</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/procedure/" rel="tag">procedure</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-B+树" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/08/09/B+%E6%A0%91/" class="article-date">
  	<time datetime="2022-08-09T13:24:28.000Z" itemprop="datePublished">2022-08-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/08/09/B+%E6%A0%91/">
        B+树
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="索引底层原理"><a href="#索引底层原理" class="headerlink" title="索引底层原理"></a>索引底层原理</h1><blockquote>
<p>解释底层的索引的数据结构 - b+树</p>
</blockquote>
<h1 id="B-树"><a href="#B-树" class="headerlink" title="B+树"></a>B+树</h1><p> InnoDB 存储引擎中的 <em><strong>B+ 树索引</strong></em>。要介绍 B+ 树索引，就不得不提二叉查找树，</p>
<p>平衡二叉树和 B 树这三种数据结构。B+ 树就是从他们仨演化来的。</p>
<p><strong>索引文件和数据文件 - innodb中 - 合二为一的 - 只有1个文件</strong></p>
<p><strong>索引文件和数据文件 - myisam中 - 分开独立的 - 俩个文件</strong></p>
<h1 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h1><p><img src="/%E4%BA%8C%E5%8F%89%E6%A0%91.jpg">  </p>
<p><em><strong>节点(每个圆圈圈)中存储了键（key - 主键索引列）和数据（data - 每一个行记录）</strong></em>。<strong>键对应 user 表中的 id</strong>，<strong>数据对应 user 表中的行数据。</strong></p>
<p>二叉查找树的特点就是任何节点的<strong>左子节点的键值都小于当前节点的键值</strong>，<strong>右子节点的键值都大于当前节点的键值</strong>。顶端的节点我们称为<strong>根节点</strong>，<strong>没有子节点的节点我们称之为<em>叶节点</em>。</strong></p>
<blockquote>
<p>如果我们需要查找 id=12 的用户信息，利用我们创建的二叉查找树索引，查找流程如下：</p>
<ol>
<li><p>id=12先和根节点[只有一个]key=10,发现id=12&gt;id=10 - 顺利向着根节点的右边去匹配</p>
</li>
<li><p>id=12和非叶节点id=13的进行匹配,顺利执行id=13的左边</p>
</li>
<li><p>id=12和id=12比较 - 两者是相同的.由于每个节点除了保存key还保存了value[行记录 - 行真实的行数据]</p>
<p>直接将这个节点的value直接取出来了.</p>
</li>
</ol>
<p>总结 - <strong>总共匹配了3次就可以顺利找到我们的数据.</strong></p>
<p><strong>如果没有创建二叉树索引.查找id=12,必然会进行全表扫描.从表的第一行向下找.最好的状态也得找6次</strong></p>
</blockquote>
<h1 id="平衡二叉树"><a href="#平衡二叉树" class="headerlink" title="平衡二叉树"></a>平衡二叉树</h1><h2 id="二叉树带来的弊端"><a href="#二叉树带来的弊端" class="headerlink" title="二叉树带来的弊端"></a>二叉树带来的弊端</h2><blockquote>
<p>二叉查找树的特点就是任何节点的<strong>左子节点的键值都小于当前节点的键值</strong>，<strong>右子节点的键值都大于当前节点的键值</strong></p>
<p>二叉树在极端的场景下有可能成为一个链表的结构[链表的查询效率很低很低的.]</p>
<p>查找id=12,”链表结构”,只能从链表的头节点开始查找,最佳状态也得寻找找了5次.</p>
</blockquote>
<blockquote>
<p><img src="C:/Users/liming/Desktop/imgs/link.jpg"> </p>
</blockquote>
<h2 id="AVL"><a href="#AVL" class="headerlink" title="AVL"></a>AVL</h2><p>为了解决这个问题[<strong>防止二叉树变成了链表结构导致查询效率依然低下</strong>]，我们需要保证二叉查找树一直保持平衡，就需要用到平衡二叉树.</p>
<p><strong>平衡二叉树又称 AVL 树</strong>，在满足二叉查找树特性的基础上，要求<strong>每个节点的左右子树的高度差不能超过 1。</strong> </p>
<p>下面是平衡二叉树和非平衡二叉树的对比：</p>
<p><img src="/diff.png"> </p>
<p><code>只要找到任何一个节点的左右子树高度差的绝对值大于1 - 非平衡二叉树</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">节点45 - 左子树高度 = 左边的子节点的个数 = 2</span><br><span class="line">			- 右子树高度 = 右边没有节点 = 0</span><br><span class="line">			- |高度差|=2&gt;1</span><br></pre></td></tr></tbody></table></figure>

<h1 id="B树"><a href="#B树" class="headerlink" title="B树"></a>B树</h1><blockquote>
<p><strong>平衡二叉树暴露出来了一些缺点:</strong></p>
<p>每个<strong>节点仅仅保存一个key-value键值对[每个节点可保存的键值对数据太少了]</strong>.每次进行查询的时候,实际上都是需要从磁盘中读取数据的.</p>
<p><strong>那我们每查找一次数据就需要从磁盘中读取一个节点，也就是我们说的一个磁盘块</strong></p>
<p>由于每个节点可保存的数据不多,仅仅保存了一个key-value.在查找数据的过程中,它就不断去和磁盘进行IO交互.</p>
<p>导致平衡二叉树的节点比较多.也就导致了平衡二叉树的高度比较高 - 导致比较的次数比较多 - 频繁和IO进行交互 - 查询效率低下.</p>
</blockquote>
<p><img src="/n.jpg"> </p>
<blockquote>
<p>为了解决平衡二叉树的高度太高问题.B树登场了.</p>
<p>B树特点</p>
<ol>
<li><p>根节点[第一页] - 永驻内存.</p>
</li>
<li><p>每个节点可以保存多个key-value - 导致子节点也会增多.B树又矮又胖.</p>
</li>
<li><p>没有子节点的节点 - 叶节点,有子节点的节点 - 非叶节点</p>
</li>
<li><p>B树的m阶 - m值就是看它最大的子节点的个数 - 3 , 下面的图代表的就是3阶b树.</p>
<p>如果有10亿条数据,<strong>只需要和磁盘进行交互2次.把磁盘块中的一页数据[16kb]全部加载到内存中.</strong></p>
</li>
<li><p>页page的概念 - 那我们每查找一次数据就需要从磁盘中读取一个节点，也就是我们说的一个磁盘块</p>
<p>读取的单位是 - 页 - 1页的磁盘块的数据大小是<strong>16kb</strong>,每个节点可以更多的key-value</p>
</li>
<li><p><strong>页与也之间是一个链表的结构</strong></p>
</li>
<li><p>查找id=28的数据 - 磁盘交互了3次</p>
<p>①id=28到第一页中进行匹配,发现id=28在17和35之间,获取p2指针.p2指向到页3</p>
<p>②定位到页3,发现id=28在26~30之间,继续拿到p2指针,p2指向的是页8</p>
<p>③定位到页8,顺利匹配查找到id=28这条数据</p>
</li>
</ol>
</blockquote>
<p><img src="/b.jpg"> </p>
<h1 id="B-树-1"><a href="#B-树-1" class="headerlink" title="B+树"></a>B+树</h1><blockquote>
<p>是Innodb和myisam存储引擎中索引底层的数据结构 - B+树</p>
<p>B树中每个节点中不仅仅存储key[索引列值,主键列值],还存储了数据.因为数据库中的页的大小是固定的[Innodb默认是16kb],</p>
<p>导致每个节点的存储资源有点浪费了.</p>
</blockquote>
<blockquote>
<p>B+树和B树的重要区别就是</p>
<ol>
<li><p><strong>B+树中非叶节点,仅仅保存了key值[索引列,主键列值],没有保存数据.每个非叶节点可以保存更多的key</strong></p>
</li>
<li><p>B+树中索引的所有的数据都放在了叶子节点中,而且是<strong>按照顺序排列的.</strong></p>
</li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li>**页与页之间是双向链表结构,**叶节点中的每个数据节点单向链表</li>
<li>下面这个图展示的是Innodb中的索引的结构.并不是Myisam中索引的结构</li>
<li>以下图示本质上就是<strong>聚簇索引[主键列索引]的方式 - key - 主键列</strong></li>
</ol>
</blockquote>
<p><img src="/B+.jpg"> </p>
<h1 id="聚簇索引和非聚簇索引"><a href="#聚簇索引和非聚簇索引" class="headerlink" title="聚簇索引和非聚簇索引"></a>聚簇索引和非聚簇索引</h1><p>在上节介绍 B+ 树索引的时候，我们提到了图中的索引其实是聚集索引的实现方式。</p>
<p>那什么是聚集索引呢？在 MySQL 中，B+ 树索引按照存储方式的不同分为聚集索引和非聚集索引。</p>
<p>这里我们着重介绍 InnoDB 中的聚集索引和非聚集索引：</p>
<ul>
<li><p>聚集索引（聚簇索引）：<em><strong>以 InnoDB 作为存储引擎的表，表中的数据都会有一个主键，即使你不创建主键，系统也会帮你创建一个隐式的主键。</strong></em></p>
<p>这是因为 InnoDB 是把数据存放在 B+ 树中的，而 B+ 树的键值就是主键，<strong>在 B+ 树的叶子节点中，存储了表中所有的数据。</strong></p>
<p><strong>这种以主键作为 B+ 树索引的键值而构建的 B+ 树索引，我们称之为聚集索引。</strong></p>
</li>
<li><p>非聚集索引（非聚簇索引）：以主键以外的列值作为键值构建的 B+ 树索引，我们称之为非聚集索引。</p>
<p>非聚集索引与聚集索引的区别在于<em><strong>非聚集索引的叶子节点不存储表中的数据，而是存储该列对应的主键</strong></em>，想要<strong>查找数据我们还需要根据主键再去聚集索引中进行查找</strong>，这个再根据聚集索引查找数据的过程，我们称为<em><strong>回表</strong></em>。</p>
</li>
</ul>
<h2 id="聚簇索引存储和查找"><a href="#聚簇索引存储和查找" class="headerlink" title="聚簇索引存储和查找"></a>聚簇索引存储和查找</h2><blockquote>
<ol>
<li>先到非叶节点找到索引列所在的页位置</li>
<li>根据页位置定位到叶节点的位置</li>
<li>叶节点中根据索引列的值找出数据</li>
</ol>
</blockquote>
<p><img src="/jusearch.jpg" alt="B+树"> </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select * from xx where id&gt;=18 and id&lt;41;</span><br><span class="line">-- 聚簇索引的查找方式 - 根据主键列id列进行查找的流程</span><br><span class="line">1. 先从页1中看id的区间,定位到p2-&gt;页3</span><br><span class="line">2. 定位到页3,定位到p1-&gt;页8[叶节点-单向链表 - 查找必须从头节点开始找]</span><br><span class="line">3. 依次按照链表的顺序一致找到id开始&lt;41的这个节点.满足条件的叶节点中的数据全部查出来 [叶节点中保存了真实的数据]</span><br></pre></td></tr></tbody></table></figure>



<h2 id="非聚簇索引存储和查找"><a href="#非聚簇索引存储和查找" class="headerlink" title="非聚簇索引存储和查找"></a>非聚簇索引存储和查找</h2><blockquote>
<p>B+树的结构</p>
<p>表结构:<strong>id</strong> age <strong>name</strong></p>
<p>id - 主键列 - 默认是聚簇索引列 - 主键列</p>
<p>name - <strong>非聚簇索引列 - 索引列 - 辅助索引</strong></p>
</blockquote>
<blockquote>
<p><img src="/x.png"> </p>
</blockquote>
<blockquote>
<p>非聚簇索引 - 非主键列索引 - <strong>name列创建了索引</strong> - 辅助索引.</p>
</blockquote>
<blockquote>
<p>结构:</p>
<ol>
<li><p>根节点 - 一页数据 - 非聚簇索引列值 - name</p>
</li>
<li><p>非叶节点 - 非聚簇索引列值</p>
</li>
<li><p><strong>页节点存储的东西 - name索引列以及该列对应的主键列值.</strong> - <strong>这是和聚簇索引最大的一个不同点</strong></p>
<p>它和聚簇索引最大的区别是页节点中没有存储最终的数据.而是存储的是键值对x-y</p>
<p>x就是非聚簇索引列值,y是对应的主键列值.</p>
</li>
</ol>
</blockquote>
<blockquote>
<p>非聚簇索引的查找方式:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from xxx where name='Bob';</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<ol>
<li><p>按照B+树的查找流程 - 确认name=’Bob’的具体位置</p>
</li>
<li><p>由于非聚簇索引的结构中叶节点仅仅保存了name-主键列值</p>
</li>
<li><p>先根据name=’Bob’这个条件找到对应的主键列值id=15</p>
</li>
<li><p><strong>要进行”回表操作”</strong></p>
<p><img src="/y.png"></p>
</li>
</ol>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<ol start="5">
<li><p>继续拿着主键列id=15到索引的结构中继续查找一次 - “一次回表查找”.</p>
<p>id也是聚簇索引 - B+树的结构 - 叶子节点中存储的就是数据.</p>
<p>根据聚簇索引列的查找方式 - id=15的叶节点 - 拿到里面的数据</p>
</li>
</ol>
</blockquote>
</blockquote>
<h2 id="非聚簇索引列查找一定会回表"><a href="#非聚簇索引列查找一定会回表" class="headerlink" title="非聚簇索引列查找一定会回表?????"></a>非聚簇索引列查找一定会回表?????</h2><blockquote>
<p><strong>未必</strong> - 因为非叶节点中存储的就是索引列值.</p>
<p>查询</p>
<p>select id from xxx where name=’Bob’;<br>select name from xxx where name=’Bob’;</p>
<p>不需要回表了.这条语句查询的结果name已经在非聚簇索引的非叶节点中保存了.</p>
</blockquote>
<blockquote>
<p>回表 </p>
<ol>
<li><p>根据一个非聚簇索引列查找 - 优先先到非聚簇索引的B+树中找到该列对应的主键列值[聚簇索引列值]</p>
</li>
<li><p>再拿着这个聚簇索引列的值再去到聚簇索引列的B+树中再查找一次</p>
</li>
</ol>
</blockquote>
<h1 id="myisam中的索引特点"><a href="#myisam中的索引特点" class="headerlink" title="myisam中的索引特点"></a>myisam中的索引特点</h1><blockquote>
<p>索引的本质就是一个键值对key-value</p>
<p><strong>key - 索引列值,value - 数据行的物理地址.</strong></p>
<p>主键列索引/辅助索引 -&gt; 两颗独立的B+树,都是索引列值对应的行记录的物理地址.</p>
</blockquote>
<blockquote>
<ol>
<li><p>innodb中索引和数据合并到一个文件中</p>
</li>
<li><p>myisam中索引和数据是单独的俩个文件,分别是索引文件和数据文件.</p>
</li>
<li><p>myisam中采用的是”非聚集的方式”</p>
</li>
<li><p>无论是聚簇索引还是非聚簇索引,查找方式是一样.</p>
</li>
<li><p>采用的也是B+树的结构**.只是叶节点中存储的是索引的列值以及该对应的行记录的地址.**</p>
<p>需要再根据行记录地址到表中进行定位[回表]</p>
</li>
</ol>
</blockquote>
<blockquote>
<p><img src="/img/z.jpg"> </p>
</blockquote>
<blockquote>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">主键列 - key是不允许重复的</span><br><span class="line">非主键列 - key是允许重复的.</span><br><span class="line">select * from xxx where id=5;</span><br><span class="line"></span><br><span class="line">1. 先到B+树找到找到id=5对应的节点 - 取出里面的行记录的物理地址0x6a</span><br><span class="line">2. 回表 - 直接根据行记录的物理地址直接定位到具体的一行.</span><br></pre></td></tr></tbody></table></figure></blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/B-%E6%A0%91/" rel="tag">B+树</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-sql习题1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/08/09/sql%E4%B9%A0%E9%A2%981/" class="article-date">
  	<time datetime="2022-08-09T13:23:45.000Z" itemprop="datePublished">2022-08-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/08/09/sql%E4%B9%A0%E9%A2%981/">
        sql习题1
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>现有一个商店的数据库，记录顾客及其购物情况，由下面三个表组成：</p>
<ol>
<li>商品product（商品号productid  int(7)]，<br>商品名productname [varchar(128)]，<br>     单价unitprice int(11,2)，<br>     商品类别category[varchar(28)]，<br>     供应商provider [varchar(48)]）；<br> 主键：productid</li>
<li>顾客customer（顾客号customerid int(7)]，<br>姓名name[varchar(48)]，<br>     住址location[varchar(128)]）；<br> 主键：customerid</li>
<li>购买purcase（顾客号customerid，商品号productid，<br>购买数量quantity[int(7)]）；<br> 外键：customerid  引用 客户表的 customerid<br> 外键：productid	  引用 产品表的 productid<br> 主键：(customerid, productid)   –&gt; 联合主键</li>
</ol>
</blockquote>
<blockquote>
<p><strong>任务一:使用DDL语言创建上面的表,并且设置必要的主键约束和外键约束</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">drop table product;</span><br><span class="line">create table product(</span><br><span class="line">productid int(7) primary key,</span><br><span class="line">productname varchar(128),</span><br><span class="line">unitprice double(11,2),</span><br><span class="line">catagory varchar(28),</span><br><span class="line">provider varchar(48)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">drop table customer;</span><br><span class="line">create table customer(</span><br><span class="line">customerid int(7) primary key,</span><br><span class="line">name varchar(48),</span><br><span class="line">location varchar(128)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">drop table purcase;</span><br><span class="line">create table purcase(</span><br><span class="line">customerid int(7),</span><br><span class="line">productid  int(7),</span><br><span class="line">quantity int(7),</span><br><span class="line">constraint purcase_id_pk primary key(customerid,productid),</span><br><span class="line">constraint purcase_id1_fk foreign key(productid) references product(productid),</span><br><span class="line">constraint purcase_id2_fk foreign key(customerid) references customer(customerid)   </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into product values(1,'佳洁士',8.00,'牙膏','宝洁'),(2,'高露洁',6.50,'牙膏','高露洁'),</span><br><span class="line">(3,'洁诺',5.00,'牙膏','联合利华'),</span><br><span class="line">(4,'舒肤佳',3.00,'香皂','宝洁'),</span><br><span class="line">(5,'夏士莲',5.00,'香皂','联合利华'),</span><br><span class="line">(6,'雕牌',2.50,'洗衣粉','纳爱斯'),</span><br><span class="line">(7,'中华',3.50,'牙膏','联合利华'),</span><br><span class="line">(8,'汰渍',3.00,'洗衣粉','宝洁'),</span><br><span class="line">(9,'碧浪',4.00,'洗衣粉','宝洁');</span><br><span class="line"></span><br><span class="line">insert into customer values(1,'Dennis','黄浦区'),</span><br><span class="line">(2,'John','徐家汇'),</span><br><span class="line">(3,'Tom','闸北'),</span><br><span class="line">(4,'Jenny','静安'),</span><br><span class="line">(5,'Rick','浦东');</span><br><span class="line"></span><br><span class="line">insert into purcase values(1,1,3),     </span><br><span class="line">(1,5,2),</span><br><span class="line">(1,8,2) ,   </span><br><span class="line">(2,2,5),</span><br><span class="line">(2,6,4) ,    </span><br><span class="line">(3,1,1),</span><br><span class="line">(3,5,1 ),    </span><br><span class="line">(3,6,3),</span><br><span class="line">(3,8,1 ),    </span><br><span class="line">(4,3,7),</span><br><span class="line">(4,4,3 ),    </span><br><span class="line">(5,6,2),</span><br><span class="line">(5,7,8);</span><br></pre></td></tr></tbody></table></figure>


</blockquote>
<blockquote>
<p><strong>任务二: 向对应的表中插入如下数据</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">商品（1，佳洁士，8.00，牙膏，宝洁；</span><br><span class="line">   2，高露洁，6.50，牙膏，高露洁；</span><br><span class="line">   3，洁诺，5.00，牙膏，联合利华；</span><br><span class="line">   4，舒肤佳，3.00，香皂，宝洁；</span><br><span class="line">   5，夏士莲，5.00，香皂，联合利华；</span><br><span class="line">   6，雕牌，2.50，洗衣粉，纳爱斯</span><br><span class="line">   7，中华，3.50，牙膏，联合利华；</span><br><span class="line">   8，汰渍，3.00，洗衣粉，宝洁；</span><br><span class="line">   9，碧浪，4.00，洗衣粉，宝洁；）</span><br><span class="line">顾客（1，Dennis，黄浦区；</span><br><span class="line">   2，John，徐家汇；</span><br><span class="line">   3，Tom，闸北；</span><br><span class="line">   4，Jenny，静安；</span><br><span class="line">   5，Rick，浦东；） </span><br><span class="line">购买(1，1，3；     </span><br><span class="line">  1，5，2；</span><br><span class="line">  1，8，2；     </span><br><span class="line">  2，2，5；</span><br><span class="line">  2，6，4；     </span><br><span class="line">  3，1，1；</span><br><span class="line">  3，5，1；     </span><br><span class="line">  3，6，3；</span><br><span class="line">  3，8，1；     </span><br><span class="line">  4，3，7；</span><br><span class="line">  4，4，3；     </span><br><span class="line">  5，6，2；</span><br><span class="line">  5，7，8；）</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<blockquote>
<p><strong>任务三: 完成如下语句</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">（1）求购买了供应商"宝洁"产品的所有顾客；</span><br><span class="line">select distinct c.customerid,c.name from customer c join purcase p on p.customerid=c.customerid where p.productid  in (select pr.productid from product pr where pr.provider='宝洁');</span><br><span class="line">+------------+--------+</span><br><span class="line">| customerid | name   |</span><br><span class="line">+------------+--------+</span><br><span class="line">|          1 | Dennis |</span><br><span class="line">|          3 | Tom    |</span><br><span class="line">|          4 | Jenny  |</span><br><span class="line">+------------+--------+</span><br><span class="line">（2）求购买的商品包含了顾客"Dennis"所购买的所有商品的顾客（姓名）</span><br><span class="line">select p2.customerid from purcase p2 where p2.productid in (select p.productid from customer c join purcase  p on c.customerid=p.customerid where c.name='Dennis') and customerid&lt;&gt;(select distinct p4.customerid from customer c4 join purcase p4 on p4.customerid=c4.customerid where c4.name="Dennis") group by p2.customerid having count(*)&gt;=(select count(*) from customer c2 join purcase p3  on c2.customerid=p3.customerid where c2.name='Dennis');</span><br><span class="line">+------------+</span><br><span class="line">| customerid |</span><br><span class="line">+------------+</span><br><span class="line">|          3 |</span><br><span class="line">+------------+</span><br><span class="line">（3）求牙膏卖出数量最多的供应商。</span><br><span class="line">select pr.provider,sum(pu1.quantity) from product pr join purcase pu1 on pu1.productid=pr.productid and pr.catagory='牙膏' GROUP BY pr.provider order by sum(pu1.quantity) desc limit 1;</span><br><span class="line">+--------------+-------------------+</span><br><span class="line">| provider     | sum(pu1.quantity) |</span><br><span class="line">+--------------+-------------------+</span><br><span class="line">| 联合利华     |                15 |</span><br><span class="line">+--------------+-------------------+</span><br><span class="line"></span><br><span class="line">(4)将所有的牙膏商品单价增加10%。</span><br><span class="line">update product set unitprice=unitprice*1.1 where catagory='牙膏';</span><br><span class="line"></span><br><span class="line">(5)删除从未被购买的商品记录。</span><br><span class="line">delete from product where productid  not in (select pu.productid from purcase pu);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/homework/" rel="tag">homework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-mysql3" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/08/09/mysql3/" class="article-date">
  	<time datetime="2022-08-09T13:23:13.000Z" itemprop="datePublished">2022-08-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/08/09/mysql3/">
        mysql3
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="DB设计"><a href="#DB设计" class="headerlink" title="DB设计"></a>DB设计</h1><blockquote>
<p>指导db设计的思想,避免表中出现大量的冗余的数据.但是实际开发中表中是允许出现冗余的字段的.</p>
<p>冗余数据的好处 - 安全,方便查询.坏处-&gt;delete和update操作</p>
</blockquote>
<blockquote>
<ol>
<li><p>1NF - 第一范式-保证列的原子性,保证列不可再切割</p>
<p>s_emp(id,name) - 发现name不具备原子性,可以被再次切割(fist_name,last_name)</p>
<p>s_ord(id,address) - address显示为省市区 - 江苏省苏州市园区</p>
<p>address再次分成(province,city,area)</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">主要是为了查询.</span><br><span class="line"></span><br><span class="line">select * from s_ord where address like '%苏州%';</span><br><span class="line"></span><br><span class="line">select * from s_ord where city = '苏州';</span><br><span class="line"></span><br><span class="line">-- address,city加索引.</span><br><span class="line">-- 模糊查询可能导致索引失效.但是精确匹配是走索引的.</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>2NF - 基于1NF,要求非关键列要全部依赖于关键列.  不存在非关键列部分依赖于关键列</p>
<p>关键列 - 主键列 - 非空且唯一 - table中的id设置成主键列.</p>
<p>student(sid,sname,cid,cname);//关键列(sid,cid) - 确定唯一的元组(行) - 复合主键</p>
<p>sname,cname - 非关键列.</p>
<p>(sid,cid) -&gt; 唯一确定 -&gt; sname/cname</p>
<p>sid -&gt; sname,cid -&gt; cname</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">student(sid,sname)</span><br><span class="line">course(cid,cname);</span><br><span class="line">sc(sid,cid,kpi);//(sid,cid) -&gt; kpi</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>3NF- 基于2NF,要求非关键列不能传递依赖于关键列.</p>
<p>student(sid,sname,uid,uv_name,u_phone);</p>
<p>u_phone传递依赖于sid - <code>原因sid -&gt; uid -&gt; u_phone</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">student(sid,sname,uid);//uid就是foreign key 外键列</span><br><span class="line">university(uid,u_name,u_phone);</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><blockquote>
<ol>
<li>用户表t_user</li>
<li>视频表t_video</li>
<li>评论表和回复表设计</li>
</ol>
</blockquote>
<blockquote>
<p>用户对视频进行评论(t_comment)和回复(t_repy)的场景:</p>
<p>tom 发布了 搞笑的视频</p>
<p>admin 评论:  😁😎</p>
<p>​             li评论admin: 你笑什么!</p>
<p>​			 lei回复@li: 管你什么事情!</p>
<p>​			 x回复@li: 你想表达什么!</p>
<p>​			 y回复@x: ….</p>
<p>​			 k 评论admin:你笑什么!</p>
<p>jack  评论: 😄</p>
</blockquote>
<p><code>t_user</code></p>
<table>
<thead>
<tr>
<th>id</th>
<th>usernmae</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>tom</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>admin</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>li</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>lei</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>x</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>y</td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>k</td>
<td></td>
</tr>
</tbody></table>
<p><code>t_video</code></p>
<p>一个用户可以发布多个视频</p>
<table>
<thead>
<tr>
<th>id</th>
<th>video</th>
<th>user_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>佩洛西</td>
<td>1</td>
</tr>
</tbody></table>
<p><code>t_comment</code></p>
<table>
<thead>
<tr>
<th>id</th>
<th>video_id</th>
<th>content</th>
<th>comment_id</th>
<th>user_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>😁😎</td>
<td></td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>你笑什么!</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>你笑什么!</td>
<td>1</td>
<td>7</td>
</tr>
</tbody></table>
<p><code>t_reply</code></p>
<table>
<thead>
<tr>
<th>id</th>
<th>comment_id</th>
<th>conent</th>
<th>reply_id</th>
<th>user_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2</td>
<td>管你什么事情!</td>
<td></td>
<td>4</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>你想表达什么!</td>
<td></td>
<td>5</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>…</td>
<td>2</td>
<td>6</td>
</tr>
</tbody></table>
<h1 id="DDL语言"><a href="#DDL语言" class="headerlink" title="DDL语言"></a>DDL语言</h1><blockquote>
<p>Data Definition Language - 数据定义语言.</p>
<p>包括的命令:create drop alter comment rename truncate</p>
</blockquote>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><blockquote>
<ol>
<li><p>数字类型</p>
<ul>
<li>整数 - int/bigint</li>
<li>小数 - float/double/decimal</li>
</ul>
<p><code>要点</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">drop table t_type;</span><br><span class="line">create table t_type(</span><br><span class="line">	id int(7)</span><br><span class="line">);</span><br><span class="line">此处的7并不是代表此列的最大长度.误区:最大可保存的值是9999999</span><br><span class="line">实际上该列可以存储的最大值是由类型决定了.</span><br><span class="line"></span><br><span class="line">配置zerofill  0填充</span><br><span class="line">create table t_type(</span><br><span class="line">	id int(7) zerofill</span><br><span class="line">);</span><br><span class="line">insert into t_type values(1);</span><br><span class="line"></span><br><span class="line">不足7位,会采用0来填充</span><br><span class="line"></span><br><span class="line">+---------+</span><br><span class="line">| id      |</span><br><span class="line">+---------+</span><br><span class="line">| 0000001 |</span><br><span class="line">+---------+</span><br><span class="line"></span><br><span class="line">drop table t_type;</span><br><span class="line">create table t_type(</span><br><span class="line">	c1 float(5,2),</span><br><span class="line">  c2 double(5,2),</span><br><span class="line">  c3 decimal(5,2)</span><br><span class="line">);</span><br><span class="line">float(m,n) =&gt; m总长度,n代表的小数点</span><br><span class="line">insert into t_type(c1) values(12.345);</span><br><span class="line">mysql&gt; select * from t_type;</span><br><span class="line"></span><br><span class="line">-- 小数保留2位,并且四舍五入</span><br><span class="line">+-------+------+------+</span><br><span class="line">| c1    | c2   | c3   |</span><br><span class="line">+-------+------+------+</span><br><span class="line">| 12.35 | NULL | NULL |</span><br><span class="line">+-------+------+------+</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into t_type(c2) values(123.5); //ok</span><br><span class="line">mysql&gt; select * from t_type;</span><br><span class="line">+-------+--------+------+</span><br><span class="line">| c1    | c2     | c3   |</span><br><span class="line">+-------+--------+------+</span><br><span class="line">| 12.35 |   NULL | NULL |</span><br><span class="line">|  NULL | 123.50 | NULL |</span><br><span class="line">+-------+--------+------+</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into t_type(c2) values(1234.5);</span><br><span class="line"></span><br><span class="line">`原因:1234.5 =&gt; 1234.50 已经超过5位了`</span><br><span class="line">ERROR 1264 (22003): Out of range value for column 'c2' at row 1</span><br><span class="line"></span><br><span class="line">float/double =&gt; 非标准  decimal标准 - 对精度有特别要求的</span><br><span class="line"></span><br><span class="line">insert into t_type(c3) values(123.589);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>关于日期类型</p>
<p>date </p>
<p>datetime</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">drop table t_type;</span><br><span class="line">create table t_type(</span><br><span class="line">  id int,</span><br><span class="line">	create_date date default now()</span><br><span class="line">);</span><br><span class="line">ERROR 1067 (42000): Invalid default value for 'create_date'</span><br><span class="line"></span><br><span class="line">如果某个列期望默认值是now(),一定要设置成datetime</span><br><span class="line">drop table t_type;</span><br><span class="line">create table t_type(</span><br><span class="line">  id int,</span><br><span class="line">	create_date datetime default now()</span><br><span class="line">);</span><br><span class="line">insert into t_type(id) values(1);</span><br><span class="line"></span><br><span class="line">-- 满足日期能够支持的字符串格式</span><br><span class="line">drop table t_type;</span><br><span class="line">create table t_type(</span><br><span class="line">  id int,</span><br><span class="line">	create_date date default '2012-09-08 12:12:12'</span><br><span class="line">);</span><br><span class="line">insert into t_type(id) values(1);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>字符串类型</p>
<ul>
<li><p>char和varchar区别</p>
<p>char(n),varchar(n) =&gt; 代表的字符的个数</p>
<p>区别: char是定长,varchar是可变长.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">drop table t_type;</span><br><span class="line">create table t_type(</span><br><span class="line">   s1 char(2),</span><br><span class="line">   s2 varchar(2)</span><br><span class="line">);</span><br><span class="line">insert into t_type(s1) values('ab');</span><br><span class="line"></span><br><span class="line">insert into t_type(s2) values('abc');</span><br><span class="line"></span><br><span class="line">char(2) =&gt; 实际存储1个'a',实际消耗了2个</span><br><span class="line">varchar(2) =&gt; 假设'a',实际仅仅消耗了1个,最大消耗2个.</span><br><span class="line">varchar更加节约空间.  char效率会更高一点 - 不推荐用char</span><br><span class="line"></span><br><span class="line">-- oracle中数据中</span><br><span class="line">drop table t_type;</span><br><span class="line">create table t_type(</span><br><span class="line">   s1 char(2)</span><br><span class="line">);</span><br><span class="line">insert into t_type(s1) values('a');</span><br><span class="line"></span><br><span class="line">-- oracle查询为empty</span><br><span class="line">-- mysql中空直接比较的时候剔除,大小写比较都是一样的.</span><br><span class="line">select * from t_type where s1='a';</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>text - 0-65 535 bytes - 长文本</p>
</li>
</ul>
</li>
</ol>
</blockquote>
<h2 id="约束类型"><a href="#约束类型" class="headerlink" title="约束类型"></a>约束类型</h2><blockquote>
<ol>
<li><p>主键约束 primary key 非空且唯一</p>
<p>主键列可以是由多列共同组成 - 符合主键列</p>
<p>但是表中只能出现一个主键</p>
</li>
<li><p>外键约束 foreign key </p>
<ul>
<li><p>外键列允许为null</p>
</li>
<li><p>外键列是多出现在多的一方中.建立表与表之间的关系的</p>
</li>
<li><p>开发中不需要设置外键 - 造成表与表之间的耦合. </p>
<p>表和表之间的关系是在”心中”!</p>
</li>
</ul>
</li>
<li><p>非空约束 - not null</p>
</li>
<li><p>唯一约束 - unique</p>
</li>
<li><p>default - 默认值</p>
</li>
<li><p>mysql中不支持自检约束,oracle中支持的check检查约束.但是mysql中可以使用触发器来实现.</p>
</li>
</ol>
</blockquote>
<h1 id="创建表语法"><a href="#创建表语法" class="headerlink" title="创建表语法"></a>创建表语法</h1><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DROP table 表名;</span><br><span class="line">-- 约束列级添加</span><br><span class="line">CREATE TABLE 表名(</span><br><span class="line">	列名 数据类型(n) 约束类型 COMMNET '注释',</span><br><span class="line">  列名 数据类型(n) 约束类型 COMMNET '注释'</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">engine 指定存储引擎,默认的就是innodb(外键约束,事务,行锁,表锁)</span><br><span class="line">之前的版本应该是myisam(仅仅支持表锁)</span><br><span class="line"></span><br><span class="line">-- 约束表级</span><br><span class="line">-- 约束命名规范:表名_列名_约束类型缩写</span><br><span class="line">CREATE TABLE 表名(</span><br><span class="line">	列名 数据类型(n) COMMNET '注释',</span><br><span class="line">  列名 数据类型(n) COMMNET '注释',</span><br><span class="line">  [CONSTRAINT 约束名称] 约束类型(列名),</span><br><span class="line">  [CONSTRAINT 约束名称] 约束类型(列名)</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>

<h2 id="列级添加方式"><a href="#列级添加方式" class="headerlink" title="列级添加方式"></a>列级添加方式</h2><blockquote>
<p>直接在列的后面的增加关于该列的约束</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">drop table t_user;</span><br><span class="line">create table t_user(</span><br><span class="line">	id int(7) primary key,</span><br><span class="line">username varchar(20) unique not null,</span><br><span class="line">	birthday date default '1991-09-08'</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into t_user(id) values(1);</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h2 id="表级添加方式"><a href="#表级添加方式" class="headerlink" title="表级添加方式"></a>表级添加方式</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">-- not null仅仅支持列级添加</span><br><span class="line">drop table t_user;</span><br><span class="line">create table t_user(</span><br><span class="line">	id int(7),</span><br><span class="line">  username varchar(20) not null,</span><br><span class="line"> 	birthday date,</span><br><span class="line">  constraint t_user_id_pk primary key(id),</span><br><span class="line">  constraint t_user_username_uq unique(username)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">-- 约束名 - 提高错的可读性</span><br><span class="line">insert into t_user(id) values(1);</span><br><span class="line"></span><br><span class="line">-- 数据字典 - 描述表的表</span><br><span class="line">-- 数据字典就是用来存放用户信息/用户创建的这表的信息.</span><br><span class="line">show tables;</span><br><span class="line">desc 表名;</span><br><span class="line"></span><br><span class="line">-- 使用系统自带的数据库mysql</span><br><span class="line">use information_schema</span><br><span class="line"></span><br><span class="line">-- TABLE_CONSTRAINTS 表名 - 数据字典 - 专门存储每个用户的表的约束信息</span><br><span class="line">desc table_constraints</span><br><span class="line">+--------------------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field              | Type         | Null | Key | Default | Extra |</span><br><span class="line">+--------------------+--------------+------+-----+---------+-------+</span><br><span class="line">| CONSTRAINT_CATALOG | varchar(512) | NO   |     |         |       |</span><br><span class="line">| CONSTRAINT_SCHEMA  | varchar(64)  | NO   |     |         |       |</span><br><span class="line">| CONSTRAINT_NAME    | varchar(64)  | NO   |     |         |       |</span><br><span class="line">| TABLE_SCHEMA       | varchar(64)  | NO   |     |         |       |</span><br><span class="line">| TABLE_NAME         | varchar(64)  | NO   |     |         |       |</span><br><span class="line">| CONSTRAINT_TYPE    | varchar(64)  | NO   |     |         |       |</span><br><span class="line">+--------------------+--------------+------+-----+---------+-------+</span><br><span class="line">CONSTRAINT_NAME - 约束名称</span><br><span class="line">TABLE_NAME - 表名</span><br><span class="line">CONSTRAINT_TYPE - 约束类型</span><br><span class="line"></span><br><span class="line">-- 查询出T_USER表中的约束信息</span><br><span class="line">select constraint_name,constraint_type,table_name from table_constraints</span><br><span class="line">where table_name='T_USER' and table_schema='dy';</span><br><span class="line"></span><br><span class="line">-- 查询t_user表中的所有的列的名称以及列的数据类型</span><br><span class="line">select column_name,column_type,data_type,column_key from columns where table_schema='dy' and table_name='t_user';</span><br></pre></td></tr></tbody></table></figure>

<h2 id="建表的其他语法"><a href="#建表的其他语法" class="headerlink" title="建表的其他语法"></a>建表的其他语法</h2><blockquote>
<ol>
<li><p>利用一张已经存在的表来构建另外一张表</p>
<ul>
<li><p>保留原来表中的数据</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">drop table t_user;</span><br><span class="line">create table t_user(</span><br><span class="line">	id int(7),</span><br><span class="line">  username varchar(20) not null,</span><br><span class="line"> 	birthday date,</span><br><span class="line">  constraint t_user_id_pk primary key(id),</span><br><span class="line">  constraint t_user_username_uq unique(username)</span><br><span class="line">);</span><br><span class="line">insert into t_user values(1,'tom','2021-09-08');</span><br><span class="line">insert into t_user values(2,'jack','2022-09-08');</span><br><span class="line"></span><br><span class="line">-- 克隆</span><br><span class="line">CREATE TABLE 表名 AS SELECT查询语句;</span><br><span class="line"></span><br><span class="line">create table t_user_copy as select * from t_user;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>保留原表的结构,但是不保留数据</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drop table t_user_copy;</span><br><span class="line">     </span><br><span class="line">create table t_user_copy as select * from t_user where 1=2;</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</li>
</ol>
</blockquote>
<blockquote>
<ol start="2">
<li><p>查看建表语句-DDL</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show create table 表名;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>如果是一个1:n</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drop table t_ord;</span><br><span class="line">drop table t_customer;</span><br><span class="line">create table t_customer(</span><br><span class="line">	id int(7),</span><br><span class="line">  cname varchar(20) not null,</span><br><span class="line">  constraint t_customer_id_pk primary key(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table t_ord(</span><br><span class="line">	id int(7) primary key,</span><br><span class="line">  ord_no varchar(20) not null unique,</span><br><span class="line">  total double(7,2),</span><br><span class="line">  customer_id int(7),</span><br><span class="line">  constraint t_ord_customer_id_fk foreign key(customer_id) references t_customer(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">-- 一定是父级表t_customer</span><br><span class="line">-- 删表 - 先删除子表,多的一方,外键所在的那张表.</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>n:n</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">drop table t_sc;</span><br><span class="line">drop table t_student;</span><br><span class="line">drop table t_course;</span><br><span class="line">   </span><br><span class="line">create table t_student(</span><br><span class="line">	id int primary key</span><br><span class="line">);</span><br><span class="line">create table t_course(</span><br><span class="line">	id int primary key</span><br><span class="line">);</span><br><span class="line">create table t_sc(</span><br><span class="line">	sid int,</span><br><span class="line">  cid int,</span><br><span class="line">  primary key(sid,cid),</span><br><span class="line">  foreign key(sid) references t_student(id),</span><br><span class="line">  foreign key(cid) references t_course(id)</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<h2 id="自学的知识点"><a href="#自学的知识点" class="headerlink" title="自学的知识点"></a>自学的知识点</h2><blockquote>
<p>四种分区方式 - 测试</p>
</blockquote>
<h1 id="DML操作"><a href="#DML操作" class="headerlink" title="DML操作"></a>DML操作</h1><h2 id="insert语句"><a href="#insert语句" class="headerlink" title="insert语句"></a>insert语句</h2><blockquote>
<ul>
<li><p>给表中所有的列都插入数据,但是需要注意的是顺序/类型/约束</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into 表名 values(列1,列2,列3);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>给指定的列插入数据</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into 表名(列名1,列名2) values(列1,列2);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>批量插入</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into 表名 values(列1,列2,列3),(列1,列2,列3),(列1,列2,列3);</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</blockquote>
<h2 id="delete语句"><a href="#delete语句" class="headerlink" title="delete语句"></a>delete语句</h2><blockquote>
<ul>
<li><p>delete from 表名;//删除表中的数据</p>
</li>
<li><p>delete from 表名 where 条件;</p>
</li>
<li><p>外键约束会对delete产生影响,一定是先删除子记录,然后才能够删除父记录.</p>
<p>先删除多的一方,然后才能够删除一的一方.</p>
</li>
<li><p>级联删除 - 删除的一方之前先将这个一方的子记录全部删除</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">drop table t_ord;</span><br><span class="line">drop table t_customer;</span><br><span class="line">create table t_customer(</span><br><span class="line">	id int(7),</span><br><span class="line">  cname varchar(20) not null,</span><br><span class="line">  constraint t_customer_id_pk primary key(id)</span><br><span class="line">);</span><br><span class="line">insert into t_customer values(1,'admin');</span><br><span class="line">insert into t_customer values(2,'tom');</span><br><span class="line"></span><br><span class="line">create table t_ord(</span><br><span class="line">	id int(7) primary key,</span><br><span class="line">  ord_no varchar(20) not null unique,</span><br><span class="line">  total double(7,2),</span><br><span class="line">  customer_id int(7),</span><br><span class="line">  constraint t_ord_customer_id_fk foreign key(customer_id) references t_customer(id) on delete cascade</span><br><span class="line">);</span><br><span class="line">insert into t_ord values(1,'1001',300,1);</span><br><span class="line">insert into t_ord values(2,'1002',300,null);</span><br></pre></td></tr></tbody></table></figure>


<p>delete from t_customer where id=1;</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</blockquote>
<h2 id="update语句"><a href="#update语句" class="headerlink" title="update语句"></a>update语句</h2><blockquote>
<ul>
<li>update 表 set 列名=列值,列名2=列值;//更新表中所有行</li>
<li>update 表 set 列名=列值,列名2=列值 WHERE条件;//</li>
</ul>
</blockquote>
<h2 id="truncate和delete和drop"><a href="#truncate和delete和drop" class="headerlink" title="truncate和delete和drop"></a>truncate和delete和drop</h2><p><code>共同点</code></p>
<blockquote>
<p>1.truncate和不带where子句的delete、以及drop都会删除表内的数据。</p>
<p>2.drop、truncate都是DDL语句(数据定义语言),执行后会自动提交。</p>
</blockquote>
<p><code>不同点</code></p>
<blockquote>
<p> delete 语句是数据库操作语言(dml)，这个操作会放到 rollback segement 中，事务提交之后才生效；如果有相应的 trigger，执行的时候将被触发。</p>
<p> <strong>truncate</strong>、drop 是数据库定义语言(ddl)，操作立即生效，原数据不放到 rollback segment 中，<strong>不能回滚</strong>，操作不触发 trigger</p>
</blockquote>
<blockquote>
<p>速度，一般来说: drop&gt; truncate &gt; delete</p>
</blockquote>
<h1 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h1><blockquote>
<ul>
<li>limit m  // 前m行</li>
<li>limit m,n //   m从下标0开始(第一行),n显示行数</li>
</ul>
</blockquote>
<h2 id="分页的公式"><a href="#分页的公式" class="headerlink" title="分页的公式"></a>分页的公式</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Page&lt;Book&gt; <span class="title function_">page</span><span class="params">(Integer pageNum,Integer pageSize)</span>{</span><br><span class="line">    <span class="comment">// limit (pageNum-1)*pageSize,pageSize</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">//1,3    0</span></span><br><span class="line">    <span class="comment">//2,2    3</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="分页的查询效率问题"><a href="#分页的查询效率问题" class="headerlink" title="分页的查询效率问题"></a>分页的查询效率问题</h2><blockquote>
<p>limit m,n 其中的m叫做偏移量. 偏移量越大,分页的性能越低.</p>
<p>比如表1-100000,正好id=1,10000</p>
<p>select * from 表 where id&gt;条件 limit 2;</p>
<p>条件查询(减少偏移量) + limit</p>
</blockquote>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><blockquote>
<p>用来执行一组SQL,是db中完成<strong>业务的基本单位.</strong></p>
</blockquote>
<h2 id="事务ACID特性"><a href="#事务ACID特性" class="headerlink" title="事务ACID特性"></a>事务ACID特性</h2><blockquote>
<ol>
<li><p>原子性（Atomicity) - 事务不可再分割.</p>
<p>事务要么同时成功,同时失败 - 比如转账业务.</p>
</li>
<li><p>一致性(Consistency) - 事务一旦提交.内存中的数据要和磁盘上的数据要一致,保证数据的完整性.</p>
<p>比如tom-500,jack-500.无论转多少,转多少次.反正总的钱是1000</p>
</li>
<li><p>隔离性(isolation): 事务与事务之间的彼此隔离的,互不干扰的.一个事务的结束,意味着下一个事务的开始.</p>
</li>
<li><p>持久性(Durability) - 事务一旦提交,数据应该永久保存在磁盘中.即使发生一些故障,应该可以用一些恢复的技术进行恢复.</p>
</li>
</ol>
</blockquote>
<h2 id="事务的分类"><a href="#事务的分类" class="headerlink" title="事务的分类"></a>事务的分类</h2><blockquote>
<ol>
<li>本地事务 - 一个项目(单体架构)连接一个数据库</li>
<li>分布式事务 <ul>
<li>消息中间件 - rabbitmq,rocketmq</li>
<li>阿里的框架seata</li>
</ul>
</li>
</ol>
</blockquote>
<h2 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h2><blockquote>
<ol>
<li><p>① Serializable (串行化)：可避免脏读、不可重复读、幻读的发生。</p>
<p>锁表.</p>
</li>
<li><p>② Repeatable read (可重复读)：可避免脏读、不可重复读的发生。</p>
</li>
<li><p>③ Read committed (读已提交)：可避免脏读的发生。</p>
<p>一个事务只能读取到另外一个事务已经提交的数据.</p>
</li>
<li><p>④ Read uncommitted (读未提交)：最低级别，任何情况都无法保证。产生脏读.</p>
<p>一个事务可以读取到另外一个事务尚未提交的数据</p>
</li>
</ol>
</blockquote>
<h2 id="查询当前会话的隔离级别"><a href="#查询当前会话的隔离级别" class="headerlink" title="查询当前会话的隔离级别"></a>查询当前会话的隔离级别</h2><p><code>mysql默认的是可重复读的隔离级别</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">select @@tx_isolation;</span><br><span class="line"></span><br><span class="line">+-----------------+</span><br><span class="line">| @@tx_isolation  |</span><br><span class="line">+-----------------+</span><br><span class="line">| REPEATABLE-READ |</span><br><span class="line">+-----------------+</span><br><span class="line"></span><br><span class="line">临时设置一下当前会话的事务的隔离级别</span><br><span class="line">set session transaction isolation level read uncommitted;</span><br></pre></td></tr></tbody></table></figure>

<h1 id="事务TCL命令"><a href="#事务TCL命令" class="headerlink" title="事务TCL命令"></a>事务TCL命令</h1><blockquote>
<p>begin(开启一个事务),commit(提交一个事务),savepoint 事务点</p>
<p>set autocommit=0;//手动开启一个事务</p>
<p>DML操作默认都是会自动提交事务.</p>
</blockquote>
<h2 id="补充一点"><a href="#补充一点" class="headerlink" title="补充一点"></a>补充一点</h2><blockquote>
<ol>
<li><p>rollback - 回滚事务 - 结束一个事务</p>
<p>不能回滚已经commit之后的事务.</p>
</li>
<li><p>savepoint 事务点</p>
<p>rollback to 事务点</p>
<p>如果么有设置事务点 - 回滚当前事务中所有的操作.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update t_acc set balance=balance+1000 where id=1;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; savepoint t1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update t_acc set balance=balance+1000 where id=2;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; rollback to t1;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; commit;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<h1 id="多事务并发带来的问题"><a href="#多事务并发带来的问题" class="headerlink" title="多事务并发带来的问题"></a>多事务并发带来的问题</h1><blockquote>
<p>多个事务对同一个数据进行操作的时候,会产生一些问题</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">drop table t_acc;</span><br><span class="line">create table t_acc(</span><br><span class="line">	id int,</span><br><span class="line">balance double(7,2)</span><br><span class="line">);</span><br><span class="line">insert into t_acc values(1,10000),(2,10000);</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h2 id="脏读"><a href="#脏读" class="headerlink" title="脏读"></a>脏读</h2><blockquote>
<p>一个事务读到了另外一个事务没有提交的数据 - 绝对不允许的.</p>
<p><img src="C:/Users/liming/Desktop/zang.png">  </p>
</blockquote>
<h2 id="不可重复读"><a href="#不可重复读" class="headerlink" title="不可重复读"></a>不可重复读</h2><blockquote>
<p>set session transaction isolation level read committed;</p>
<p>一个事务A在读取一次之后,另外一个事务B在进行update操作.并且commit.</p>
<p>A事务在没有自己没有提交之前,读取到了B事务提交之后的数据.导致A事务在当前事务中多次读取到的结果不一样.</p>
<p><img src="C:/Users/liming/Desktop/no.png"> </p>
</blockquote>
<h2 id="幻读"><a href="#幻读" class="headerlink" title="幻读"></a>幻读</h2><blockquote>
<p>它和不可重复读类似.侧重点不同.不可重复读强调的是一个事务在查询.另外一个事务在修改(update)</p>
<p>幻读强调的是一个事务在修改.另外一个事务在插入(insert).</p>
<p>set session transaction isolation level read committed;</p>
<p><img src="C:/Users/liming/Desktop/huan.png"> </p>
</blockquote>
<blockquote>
<p>事务A在修改,事务B-insert并且提交了.事务A在本事务中再次查询,发现了好像有”更新失败”的数据.就像发生了幻觉一样.</p>
</blockquote>
<h2 id="可重复读"><a href="#可重复读" class="headerlink" title="可重复读"></a>可重复读</h2><blockquote>
<p>默认的隔离级别</p>
<p>set session transaction isolation level repeatable read;</p>
</blockquote>
<blockquote>
<p>事务A读取一次,事务B执行update操作.事务A在没有结束当前事务之前,多次读取到的结果是一样的.</p>
<p>必须要commit之后,才能够读取到B事务提交之后的修改数据.</p>
<p><img src="C:/Users/liming/Desktop/repeat.png"> </p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><table>
<thead>
<tr>
<th></th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>读未提交</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>读已提交</td>
<td>×</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>可重复读</td>
<td>×</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>串行化</td>
<td>×</td>
<td>×</td>
<td>×</td>
</tr>
</tbody></table>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/meet-DB/" rel="tag">meet DB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-mysql2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/08/09/mysql2/" class="article-date">
  	<time datetime="2022-08-09T13:22:58.000Z" itemprop="datePublished">2022-08-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/08/09/mysql2/">
        mysql2
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="视图-view"><a href="#视图-view" class="headerlink" title="视图-view"></a>视图-view</h1><blockquote>
<p>我们使用create命令来构建database,user,<strong>table(基本单位)</strong>,view,索引,函数,存储过程,触发器 - 数据库的单位.</p>
<p>视图实际上就是一张”虚拟表”,实际上是不存在的.只是逻辑上的查询结果的集合.</p>
</blockquote>
<h2 id="视图的分类"><a href="#视图的分类" class="headerlink" title="视图的分类"></a>视图的分类</h2><blockquote>
<ol>
<li><p>简单视图</p>
<p>视图来自于单表查询的集合 - 允许执行DML操作</p>
</li>
<li><p>复杂视图</p>
<p>视图来自于多表关联查询的集合 - 不一定允许执行DML操作.</p>
</li>
</ol>
</blockquote>
<h2 id="创建的语法"><a href="#创建的语法" class="headerlink" title="创建的语法"></a>创建的语法</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DROP view 视图名;</span><br><span class="line"></span><br><span class="line">CREATE VIEW 视图名</span><br><span class="line">AS</span><br><span class="line">SELECT查询语句;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create view t_acc_view as select * from t_acc;</span><br><span class="line"></span><br><span class="line">select * from t_acc_view;</span><br></pre></td></tr></tbody></table></figure>

<p><code>复杂视图</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">drop view co_view;</span><br><span class="line">create view co_view as</span><br><span class="line">select c.cname,o.ord_no from t_customer c join t_ord o on c.id = o.customer_id;</span><br><span class="line"></span><br><span class="line">update co_view set cname='xx'; //允许update</span><br><span class="line"></span><br><span class="line">drop view co_view;</span><br><span class="line">create view co_view as</span><br><span class="line">select customer_id,count(*) c_ from t_ord group by customer_id;</span><br><span class="line"></span><br><span class="line">-- 不允许执行update操作.</span><br><span class="line">mysql&gt; update co_view set c_=1;</span><br><span class="line">ERROR 1288 (HY000): The target table co_view of the UPDATE is not updatable</span><br></pre></td></tr></tbody></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><blockquote>
<ol>
<li><p>修改原表,视图肯定变化.有可能还会导致视图数据全部丢失.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">drop view t_acc_view;</span><br><span class="line">create view t_acc_view</span><br><span class="line">as</span><br><span class="line">select * from t_acc where balance=16000;</span><br><span class="line"></span><br><span class="line">-- 更新原表</span><br><span class="line"></span><br><span class="line">-- 更新了这个视图来源的那个条件列.</span><br><span class="line">update t_acc set balance = balance+1000 where id=2;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t_acc_view;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>修改视图 - 同样也会对原表造成影响.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">drop view t_acc_view;</span><br><span class="line">create view t_acc_view</span><br><span class="line">as</span><br><span class="line">select * from t_acc where id=1;</span><br><span class="line"></span><br><span class="line">-- 更新视图</span><br><span class="line">update t_acc_view set balance=1000 where id=1;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t_acc;</span><br><span class="line">+------+----------+</span><br><span class="line">| id   | balance  |</span><br><span class="line">+------+----------+</span><br><span class="line">|    1 |  1000.00 |</span><br><span class="line">|    2 | 17000.00 |</span><br><span class="line">|    3 | 15000.00 |</span><br><span class="line">+------+----------+</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>针对题1的情况,更新列可能导致视图失效.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">drop view t_acc_view;</span><br><span class="line">create view t_acc_view</span><br><span class="line">as</span><br><span class="line">SELECT带where的条件查询语句 with check option</span><br></pre></td></tr></tbody></table></figure>

<p><code>with check option作用:不允许更新视图的来源的那个条件列.  肯定是要配合where语句一起使用的,否则没有任何意义</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">drop view t_acc_view;</span><br><span class="line">create view t_acc_view</span><br><span class="line">as</span><br><span class="line">select * from t_acc where balance=1000 with check option;</span><br><span class="line"></span><br><span class="line">mysql&gt; update t_acc_view set balance=2000 where id=1;</span><br><span class="line">ERROR 1369 (HY000): CHECK OPTION failed 'dy.t_acc_view'</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<h2 id="视图的好处"><a href="#视图的好处" class="headerlink" title="视图的好处"></a>视图的好处</h2><blockquote>
<ol>
<li><p>封装SQL语句</p>
<p>封装比较复杂的SQL语句,在Java中直接查询视图即可.</p>
</li>
<li><p>定制数据</p>
<p>系统不同的角色 - 看到的数据应该是不一样的.</p>
</li>
<li><p>安全性</p>
<p>数据库应该有多个user账号的,可以给不同的用户授予不同的视图的权限(select,insert,update,delete)</p>
<p>授权grant</p>
</li>
<li><p>合并抽离出去的数据 - 对用户屏蔽的底层的数据库的结构的设计.</p>
</li>
</ol>
</blockquote>
<h1 id="索引-index"><a href="#索引-index" class="headerlink" title="索引-index"></a>索引-index</h1><blockquote>
<p>作用:提高查询的效率,类似于书的那个目录.</p>
</blockquote>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote>
<ol>
<li><p>Myisam存储引擎</p>
<p>索引文件和数据文件是分开存储的.是俩个独立的文件</p>
<p>数据结构:B+树</p>
</li>
<li><p>Innodb存储引擎</p>
<p>数据和索引是合二为一的,是一个文件.</p>
<p>B+树</p>
</li>
</ol>
</blockquote>
<blockquote>
<ul>
<li>索引也是占用物理空间的.</li>
<li>对表中的数据进行DML操作的时候,维护索引的-消耗一点额外的时间</li>
<li>如果表中某列重复的数据比较多,没有必要创建索引 - 查找的时候接近于全表扫描花费的时间.</li>
<li>当表中没有指定索引列,那么默认的索引列就是主键列.</li>
<li>show index from 表名 \G;</li>
</ul>
</blockquote>
<h2 id="索引的分类"><a href="#索引的分类" class="headerlink" title="索引的分类"></a>索引的分类</h2><blockquote>
<ul>
<li><p>主键索引</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Key_name: PRIMARY</span><br><span class="line"></span><br><span class="line">-- 非要删除主键约束</span><br><span class="line">alter table 表名 drop primary key;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>唯一索引</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">某列增加unique唯一约束,自动创建唯一索引</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>全文索引</p>
<p>后期会使用elasticsearch来进行全文搜索 - 搜索引擎.</p>
</li>
<li><p>复合索引 - 遵守最左匹配原则.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create index index_name on 表名(列1,列2,列3);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>普通索引</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create index index_name on 表名(列);</span><br><span class="line">drop index index_name;</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</blockquote>
<h1 id="索引失效场景※"><a href="#索引失效场景※" class="headerlink" title="索引失效场景※"></a>索引失效场景※</h1><blockquote>
<p>如何查看索引是否生效 - 索引执行计划explain select语句;</p>
<p>type - <em>const</em>&gt;eq_<em>ref</em>&gt;<em>ref</em>&gt;range&gt;index&gt;<em>all</em>)</p>
<p>type-all 全表扫描 - 索引是失效的.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">explain select * from index_test where id=1;</span><br><span class="line">+----+-------------+------------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span><br><span class="line">| id | select_type | table      | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |</span><br><span class="line">+----+-------------+------------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span><br><span class="line">|  1 | SIMPLE      | index_test | NULL       | const | PRIMARY       | PRIMARY | 4       | const |    1 |   100.00 | NULL  |</span><br><span class="line">+----+-------------+------------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drop table index_test;</span><br><span class="line">create table index_test(</span><br><span class="line">	id int(7) primary key,</span><br><span class="line">  a int(7),</span><br><span class="line">  b int(7),</span><br><span class="line">  c varchar(20),</span><br><span class="line">  d varchar(20)</span><br><span class="line">);</span><br><span class="line">insert into index_test values(1,100,10,'aaa','AAA');</span><br><span class="line">insert into index_test values(2,200,30,'aab','BBB');</span><br><span class="line">insert into index_test values(3,300,20,'caa','CCC');</span><br><span class="line">insert into index_test values(4,100,10,'daa','DDD');</span><br><span class="line">insert into index_test values(5,500,50,'aad','FFF');</span><br><span class="line"></span><br><span class="line">drop index index_test_index;</span><br><span class="line">create index index_test_index on index_test(a,b,c);</span><br><span class="line"></span><br><span class="line">create index index_test_d on index_test(d(10));//10 - 索引长度</span><br></pre></td></tr></tbody></table></figure>

<h2 id="1-复合索引需要遵守最左匹配原则"><a href="#1-复合索引需要遵守最左匹配原则" class="headerlink" title="1. 复合索引需要遵守最左匹配原则"></a>1. 复合索引需要遵守最左匹配原则</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-- a,b,c都是走了索引的.</span><br><span class="line">explain select * from index_test where a = 2 and b=200 and c='aaa';</span><br><span class="line"></span><br><span class="line">type:ref   key_len: 73</span><br><span class="line"></span><br><span class="line">-- a走了索引</span><br><span class="line">explain select * from index_test where a = 2;</span><br><span class="line">type: ref  key_len:5</span><br><span class="line"></span><br><span class="line">-- a,b都是走了索引</span><br><span class="line">explain select * from index_test where a = 2 and b=200;</span><br><span class="line">type:ref key_len:10</span><br><span class="line"></span><br><span class="line">-- b是不走的</span><br><span class="line">explain select * from index_test where b=200;</span><br><span class="line">type:ALL key_len:NULL</span><br><span class="line"></span><br><span class="line">-- type:ref   key_len: 73</span><br><span class="line">-- mysql底层发现where条件列a,b,c都是复合索引,先进行优化,a,b,c,进行查询.</span><br><span class="line">explain select * from index_test where b=200 and c='aaa' and a=2;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-模糊匹配"><a href="#2-模糊匹配" class="headerlink" title="2. 模糊匹配"></a>2. 模糊匹配</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-- %在末尾 - 生效</span><br><span class="line">explain select * from index_test where a = 2 and b=200 and c like 'a%';</span><br><span class="line"></span><br><span class="line">-- %在开头,a,b是走索引,但是c没有走索引</span><br><span class="line">explain select * from index_test where a = 2 and b=200 and c like '%a';</span><br><span class="line"></span><br><span class="line">-- %?%,a,b是走索引,但是c没有走索引</span><br><span class="line">explain select * from index_test where a = 2 and b=200 and c like '%a%';</span><br></pre></td></tr></tbody></table></figure>

<h2 id="3-查询范围之后"><a href="#3-查询范围之后" class="headerlink" title="3. 查询范围之后"></a>3. 查询范围之后</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- b&gt;=10 条件成立,范围之后的索引是生效的.  a,b,c都是走索引</span><br><span class="line">explain select * from index_test where a = 100 and b&gt;=10 and c='aaa';</span><br><span class="line"></span><br><span class="line">-- b&gt;10 条件不成立,范围之后的索引是失效的.  只有a,b是走索引的</span><br><span class="line">explain select * from index_test where a = 100 and b&gt;10 and c='aaa';</span><br></pre></td></tr></tbody></table></figure>

<h2 id="4-索引列参加了计算"><a href="#4-索引列参加了计算" class="headerlink" title="4. 索引列参加了计算"></a>4. 索引列参加了计算</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- type:ALL</span><br><span class="line">explain select * from index_test where id+1=1;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="5-索引列使用了函数"><a href="#5-索引列使用了函数" class="headerlink" title="5. 索引列使用了函数"></a>5. 索引列使用了函数</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- type:ALL</span><br><span class="line">explain select * from index_test where abs(id)=1;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="6-查询的数据超过整张表的30"><a href="#6-查询的数据超过整张表的30" class="headerlink" title="6. 查询的数据超过整张表的30%"></a>6. 查询的数据超过整张表的30%</h2><h2 id="7-is-null和is-not-null"><a href="#7-is-null和is-not-null" class="headerlink" title="7. is null和is not null"></a>7. is null和is not null</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create index emp_index on s_emp(commission_pct);</span><br><span class="line"></span><br><span class="line">-- typ:ALL is null 没有走索引</span><br><span class="line">explain select * from s_emp where commission_pct is null;</span><br><span class="line"></span><br><span class="line">-- type:range is not 走索引.</span><br><span class="line">explain select * from s_emp where commission_pct is not null;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="8-in和not-in"><a href="#8-in和not-in" class="headerlink" title="8. in和not in"></a>8. in和not in</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">explain select * from s_emp where id in(1,2,3);</span><br><span class="line">explain select * from s_emp where id not in(1,2,3);</span><br><span class="line"></span><br><span class="line">-- mysql5.7之前</span><br><span class="line">in - 走索引</span><br><span class="line">not in - 不走索引</span><br><span class="line"></span><br><span class="line">-- 8.x not in允许走索引</span><br></pre></td></tr></tbody></table></figure>

<h1 id="关于索引的长度key-len"><a href="#关于索引的长度key-len" class="headerlink" title="关于索引的长度key_len"></a>关于索引的长度key_len</h1><h2 id="计算方式"><a href="#计算方式" class="headerlink" title="计算方式"></a>计算方式</h2><blockquote>
<ol>
<li><p>数值类型 - int</p>
<p>4 + 1(该列是否为null,没有设置not null,就需要加1,存储null也占1个)</p>
</li>
<li><p>字符串类型 - varchar(n) - utf8 - n*3+2+1(没有设置not null,就需要加1,存储null也占1个)</p>
</li>
</ol>
</blockquote>
<h2 id="索引长度作用"><a href="#索引长度作用" class="headerlink" title="索引长度作用"></a>索引长度作用</h2><blockquote>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">site: www.baidu.com</span><br><span class="line">   www.baobao.com</span><br><span class="line">   www.baxy.com</span><br><span class="line">   </span><br><span class="line">site索引长度是5,不够,前缀重复比较多.</span><br><span class="line">索引长度要有区分度.</span><br><span class="line"></span><br><span class="line">推荐反转之后进行存储.减少索引长度.</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h1 id="索引的创建策略"><a href="#索引的创建策略" class="headerlink" title="索引的创建策略"></a>索引的创建策略</h1><blockquote>
<ul>
<li><p>哪些列创建索引</p>
<ul>
<li><p>主键列,唯一性列</p>
</li>
<li><p>重复性比较少,经常被查询但是同时更新不是特别频繁的列.</p>
</li>
<li><p>order by + 排序列 - 创建索引.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">order by语句本身性能就很低下的.  根据索引进行排序.</span><br><span class="line">如果是id列索引,插入的时候就会先排序了.</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>join on 列</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用来连接表的列适合建索引的.本身join越多,性能越低.</span><br><span class="line">开发中几乎都是单表查询.尽量不要去使用复杂查询.</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</li>
<li><p>不适合创建索引</p>
<ul>
<li>null值太多的列</li>
<li>重复值太多的列</li>
<li>更新比较频繁的列</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h1><blockquote>
<ol>
<li><p>行锁</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">update s_emp set first_name='xxx' where id=1;//条件列是索引列 - 行锁 - 降低锁的粒度</span><br><span class="line"></span><br><span class="line">行锁和表锁</span><br><span class="line">1. 行锁粒度小,涉及到频繁的加锁和释放锁的过程.</span><br><span class="line">3. 表锁会影响到查询效率</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">update s_emp set first_name='xxx' where id=1;//如果上面的事务没有commit,此处会阻塞</span><br><span class="line"></span><br><span class="line">如果此处更新的是另外一行,可以直接执行update s_emp set first_name='xxx' where id=2;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>表锁</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">非索引列条件更新的时候 - 锁表.</span><br><span class="line">所有的DML操作默认的申请表锁</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>页锁</p>
<p>介于行锁和表锁之间的.</p>
</li>
<li><p>共享锁</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">select语句默认申请的共享锁.</span><br><span class="line">select申请排他锁.</span><br><span class="line"></span><br><span class="line">select语句 for update;</span><br><span class="line"></span><br><span class="line">实现悲观锁</span><br><span class="line"></span><br><span class="line">更新库存stock</span><br><span class="line"></span><br><span class="line">伪代码:</span><br><span class="line"></span><br><span class="line">begin;</span><br><span class="line"></span><br><span class="line">select stock from xxx where id=1 for update;</span><br><span class="line"></span><br><span class="line">//更新stock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">commit;</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/view/" rel="tag">view</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2022 ape_li
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/preccrep/hexo-theme-jelly" target="_blank">Jelly</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>